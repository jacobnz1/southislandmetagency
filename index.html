<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMA | Global Cloud & Radar</title>
    
    <!-- LEAFLET MAP -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- SCREENSHOT TOOL -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* CORE RESET */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        #map { width: 100%; height: 100%; z-index: 1; background: #0a0a0a; }

        /* FLOATING PANEL */
        .panel {
            position: absolute; top: 20px; left: 20px; width: 300px;
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px; padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            z-index: 1000; color: white; display: flex; flex-direction: column; gap: 15px;
        }

        .header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; color: #fff; }
        .logo span { color: #3b82f6; }
        .subtitle { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; }

        /* CONTROLS */
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .c-label { font-size: 0.9rem; font-weight: 600; }
        .c-sub { font-size: 0.7rem; color: #6b7280; display: block; }
        .c-status { font-size: 0.65rem; font-family: monospace; color: #34d399; text-align: right; }

        /* TOGGLE SWITCH */
        .toggle { position: relative; width: 42px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* JUMP BUTTONS */
        .jump-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .jump-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #ccc; padding: 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer;
            text-align: center; transition: 0.2s;
        }
        .jump-btn:hover { background: rgba(255,255,255,0.15); color: white; }

        /* MAIN BUTTON */
        .dl-btn {
            background: #2563eb; color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;
            margin-top: 10px; font-size: 0.9rem;
        }
        .dl-btn:hover { background: #1d4ed8; }

        /* BRANDING (EXPORT ONLY) */
        #export-brand {
            display: none; position: absolute; bottom: 30px; right: 30px; z-index: 9999;
            background: white; color: black; padding: 12px 24px; border-radius: 8px;
            text-align: right; pointer-events: none;
        }
        .b-main { font-weight: 900; font-size: 1.5rem; }
        .b-main span { color: #2563eb; }

        body.exporting .panel, body.exporting .leaflet-control-zoom { display: none !important; }
        body.exporting #export-brand { display: block !important; }

    </style>
</head>
<body>

    <!-- MAP -->
    <div id="map"></div>

    <!-- UI PANEL -->
    <div class="panel">
        <div class="header">
            <div class="logo">SIMA<span>.co.nz</span></div>
            <div class="subtitle">Global Satellite & Radar System</div>
        </div>

        <!-- SATELLITE TOGGLE -->
        <div class="control-row">
            <div>
                <span class="c-label">Cloud Cover</span>
                <span class="c-sub">Infrared Satellite</span>
            </div>
            <label class="toggle">
                <input type="checkbox" id="sat-check" checked onchange="toggleLayer('sat')">
                <span class="slider"></span>
            </label>
        </div>
        <div class="c-status" id="sat-time">Loading...</div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 10px 0;">

        <!-- RADAR TOGGLE -->
        <div class="control-row">
            <div>
                <span class="c-label">Precipitation</span>
                <span class="c-sub">Worldwide Radar</span>
            </div>
            <label class="toggle">
                <input type="checkbox" id="rad-check" checked onchange="toggleLayer('rad')">
                <span class="slider"></span>
            </label>
        </div>
        <div class="c-status" id="rad-time">Loading...</div>

        <!-- JUMP BUTTONS -->
        <div style="font-size:0.7rem; color:#888; margin-top:15px; font-weight:600;">VERIFY DATA (JUMP TO)</div>
        <div class="jump-grid">
            <button class="jump-btn" onclick="jumpTo(-41.2, 174.7, 6)">N. Zealand</button>
            <button class="jump-btn" onclick="jumpTo(-25.2, 133.7, 4)">Australia</button>
            <button class="jump-btn" onclick="jumpTo(48.8, 2.3, 5)">Europe</button>
        </div>

        <button class="dl-btn" onclick="snapshot()">Download Map</button>
    </div>

    <!-- BRANDING -->
    <div id="export-brand">
        <div class="b-main">SIMA<span>.co.nz</span></div>
        <div style="font-size:0.8rem; font-weight:600;">Live Weather Intelligence</div>
    </div>

    <script>
        // --- VARIABLES ---
        let map;
        let layers = {
            base: null,
            labels: null,
            satellite: null, // Clouds
            radar: null      // Rain
        };
        let apiData = null; // Store RainViewer JSON

        // --- INIT ---
        window.onload = function() {
            initMap();
            loadRainViewerData(); // This drives both Sat and Radar
        };

        function initMap() {
            // Dark map to make white clouds pop
            map = L.map('map', { zoomControl: false }).setView([-41.2865, 174.7762], 6);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // 1. BASE LAYER (Dark Matter)
            layers.base = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap, © CARTO',
                subdomains: 'abcd',
                maxZoom: 19,
                zIndex: 0
            }).addTo(map);

            // 2. LABELS (City names on top)
            layers.labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 19,
                zIndex: 100 // Always on top
            }).addTo(map);
        }

        // --- DATA FETCHING ---
        async function loadRainViewerData() {
            try {
                // Fetch configuration
                const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                if(!res.ok) throw new Error("API Connection Failed");
                apiData = await res.json();
                
                // Initialize Layers
                if(document.getElementById('sat-check').checked) addSatelliteLayer();
                if(document.getElementById('rad-check').checked) addRadarLayer();

            } catch(e) {
                console.error(e);
                alert("Could not load weather data. Check internet connection.");
                document.getElementById('sat-time').innerText = "Connection Error";
                document.getElementById('rad-time').innerText = "Connection Error";
            }
        }

        // --- SATELLITE (CLOUDS) ---
        function addSatelliteLayer() {
            if (!apiData || !apiData.satellite || !apiData.satellite.infrared) return;
            
            // Get latest Infrared Satellite frame
            const frames = apiData.satellite.infrared;
            const lastFrame = frames[frames.length - 1]; // Latest
            
            // RainViewer Sat URL Pattern: /v2/satellite/{path}/512/{z}/{x}/{y}/0/1_1.png
            const url = `https://tile.cache.rainviewer.com${lastFrame.path}/512/{z}/{x}/{y}/0/1_1.png`;
            
            if (layers.satellite) map.removeLayer(layers.satellite);
            
            layers.satellite = L.tileLayer(url, {
                opacity: 0.75, // Slight transparency to see land borders
                zIndex: 10
            }).addTo(map);

            // Update Status
            const date = new Date(lastFrame.time * 1000);
            document.getElementById('sat-time').innerText = "Live: " + date.toLocaleTimeString();
        }

        // --- RADAR (RAIN) ---
        function addRadarLayer() {
            if (!apiData || !apiData.radar || !apiData.radar.past) return;

            // Get latest Radar frame
            const frames = apiData.radar.past;
            const lastFrame = frames[frames.length - 1];

            // RainViewer Radar URL Pattern: /v2/radar/{path}/512/{z}/{x}/{y}/2/1_1.png
            const url = `https://tile.cache.rainviewer.com${lastFrame.path}/512/{z}/{x}/{y}/2/1_1.png`;

            if (layers.radar) map.removeLayer(layers.radar);

            layers.radar = L.tileLayer(url, {
                opacity: 0.9,
                zIndex: 20 // Sits above clouds
            }).addTo(map);

            // Update Status
            const date = new Date(lastFrame.time * 1000);
            document.getElementById('rad-time').innerText = "Live: " + date.toLocaleTimeString();
        }

        // --- CONTROLLER ---
        function toggleLayer(type) {
            if(type === 'sat') {
                const on = document.getElementById('sat-check').checked;
                if(on) addSatelliteLayer();
                else if(layers.satellite) map.removeLayer(layers.satellite);
            }
            if(type === 'rad') {
                const on = document.getElementById('rad-check').checked;
                if(on) addRadarLayer();
                else if(layers.radar) map.removeLayer(layers.radar);
            }
        }

        function jumpTo(lat, lon, zoom) {
            map.flyTo([lat, lon], zoom, { duration: 1.5 });
        }

        // --- SNAPSHOT ---
        function snapshot() {
            document.body.classList.add('exporting');
            
            html2canvas(document.body, {
                useCORS: true,
                allowTaint: true,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `SIMA_Global_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                document.body.classList.remove('exporting');
            }).catch(e => {
                alert("Browser Security prevented the download. Please screenshot manually.");
                document.body.classList.remove('exporting');
            });
        }
    </script>
</body>
</html>
