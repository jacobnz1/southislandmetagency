<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>South Island Meteorological Agency</title>
    
    <!-- ADSENSE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8263002259646510" crossorigin="anonymous"></script>

    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================
           THEME VARIABLES
           ========================= */
        :root {
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --surface-trans: rgba(255, 255, 255, 0.98);
            --primary: #0f172a;
            --secondary: #64748b;
            --accent: #0ea5e9;
            --border: #e2e8f0;
            
            /* Risk/Alert Colors */
            --risk-slight: #eab308;    /* Yellow */
            --risk-enhanced: #f97316;  /* Orange */
            --risk-high: #ef4444;      /* Red */
            --risk-critical: #a855f7;  /* Purple */
            --risk-special: #3b82f6;   /* Blue */
            --risk-downpour: #6366f1;  /* Indigo */
            
            /* Admin Vars */
            --adm-primary: #2563eb;
            --adm-bg: #f1f5f9;
            
            --header-h: 70px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--primary); line-height: 1.6; height: 100vh; overflow: hidden; }

        /* MODES */
        #public-app, #admin-app, #login-screen { display: none; width: 100%; height: 100%; }
        body.mode-public #public-app { display: block; }
        body.mode-public { padding-top: var(--header-h); overflow-y: auto; }
        body.mode-admin { background-color: #d1d5db; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        body.mode-admin #admin-app { display: flex; width: 100%; height: 100%; }
        body.mode-login { background: #0f172a; display: flex; align-items: center; justify-content: center; overflow-y: auto; }
        body.mode-login #login-screen { display: flex; align-items: center; justify-content: center; width: 100%; }

        /* --- HEADER --- */
        header { background: var(--surface-trans); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; height: var(--header-h); display: flex; align-items: center; }
        .nav-wrap { width: 100%; max-width: 1280px; margin: 0 auto; padding: 0 20px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        .brand img { height: 42px; cursor: pointer; }

        .d-menu { display: none; height: 100%; gap: 5px; align-items: center; }
        @media(min-width: 950px) { .d-menu { display: flex; } }
        
        .nav-link { padding: 0 12px; text-decoration: none; color: var(--secondary); font-weight: 600; font-size: 0.95rem; cursor: pointer; height: 100%; display: flex; align-items: center; }
        .nav-link:hover { color: var(--accent); background: #f0f9ff; }
        
        .dropdown-container { position: relative; height: 100%; display: flex; align-items: center; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid var(--border); border-top: none; min-width: 200px; box-shadow: var(--shadow); flex-direction: column; border-radius: 0 0 8px 8px; overflow: hidden; }
        .dropdown-container:hover .dropdown-menu { display: flex; }
        .dropdown-link { padding: 12px 20px; text-decoration: none; color: var(--primary); font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; transition:0.2s; }
        .dropdown-link:hover { background: #f8fafc; color: var(--accent); padding-left: 25px; }

        .m-toggle { background: none; border: none; font-size: 1.5rem; padding: 5px; cursor: pointer; display: block; }
        @media(min-width: 950px) { .m-toggle { display: none; } }
        .m-menu { position: fixed; top: var(--header-h); right: -100%; width: 280px; height: calc(100vh - var(--header-h)); background: white; border-left: 1px solid var(--border); transition: 0.3s; z-index: 999; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .m-menu.open { right: 0; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        .m-header { font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--secondary); margin-top: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .m-link { text-decoration: none; font-weight: 600; color: var(--primary); font-size: 1rem; padding: 10px 0; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; padding-bottom: 80px; }
        .page { display: none; animation: fade 0.3s ease; }
        .page.active { display: block; }
        @keyframes fade { from{opacity:0} to{opacity:1} }

        /* --- HOME WIDGET --- */
        #si-weather-root { background: white; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; height: 650px; margin-bottom: 40px; overflow: hidden; }
        .si-sidebar { width: 380px; padding: 30px; background: white; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        #si-map { flex-grow: 1; background: #e2e8f0; z-index: 1; }
        .si-search input { width: 100%; padding: 12px 40px 12px 15px; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; font-family: inherit; }
        .si-results { position: absolute; background: white; border: 1px solid var(--border); width: 100%; max-height: 200px; overflow-y: auto; border-radius: 8px; margin-top: 5px; display: none; z-index: 500; box-shadow: var(--shadow); }
        .si-res-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .si-res-item:hover { background: #f0f9ff; color: var(--accent); }
        
        .ext-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin: 20px 0 10px 0; }
        .ext-tab { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.8rem; font-weight: 700; color: var(--secondary); cursor: pointer; border-radius: 6px; }
        .ext-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ext-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .ext-val { font-weight: 800; width: 60px; }
        .ext-town { color: var(--secondary); font-size: 0.9rem; }

        /* --- FEED CARDS --- */
        .feed-item-card { background: white; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 30px; overflow: hidden; box-shadow: var(--shadow); }
        .feed-content-wrapper { display: flex; flex-direction: column; }
        @media (min-width: 900px) {
            .feed-content-wrapper { flex-direction: row; align-items: stretch; }
            .feed-img-wrapper { width: 400px; flex-shrink: 0; border-right: 1px solid var(--border); background: #f8fafc; }
            .feed-text-wrapper { flex-grow: 1; padding: 25px; }
        }
        @media (max-width: 899px) { 
            .feed-img-wrapper { width: 100%; height: auto; border-bottom: 1px solid var(--border); }
            .feed-text-wrapper { padding: 20px; }
        }
        .map-img { width: 100%; height: 100%; object-fit: contain; min-height: 250px; background:#f1f5f9; cursor:pointer; }
        .feed-body { line-height: 1.7; white-space: pre-line; color: #334155; }

        /* Risk Styles */
        .b-Slight, .border-Slight { border-left: 6px solid var(--risk-slight); } .bg-Slight { background: var(--risk-slight); color:black; }
        .b-Enhanced, .border-Enhanced { border-left: 6px solid var(--risk-enhanced); } .bg-Enhanced { background: var(--risk-enhanced); color:white; }
        .b-High, .border-High { border-left: 6px solid var(--risk-high); } .bg-High { background: var(--risk-high); color:white; }
        .b-Critical, .border-Critical { border-left: 6px solid var(--risk-critical); } .bg-Critical { background: var(--risk-critical); color:white; }
        .b-Special { border-left: 6px solid var(--risk-special); } .bg-Special { background: var(--risk-special); color:white; }
        .b-Downpours { border-left: 6px solid var(--risk-downpour); } .bg-Downpours { background: var(--risk-downpour); color:white; }

        .alert-card { background:white; border:1px solid var(--border); border-radius:8px; margin-bottom:20px; overflow:hidden; }
        .alert-h { padding:12px 20px; background:#f9fafb; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:700; }
        .badge { padding:4px 10px; border-radius:20px; font-size:0.7rem; text-transform:uppercase; font-weight:800; }

        .fc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-top: 20px; }
        .fc-box { background: #f8fafc; border: 1px solid var(--border); padding: 15px; border-radius: 8px; }

        /* NEWS */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .news-card { text-decoration: none; color: inherit; background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column; transition: 0.2s; }
        .news-card:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: var(--shadow); }
        .nc-thumb { height: 180px; background-size: cover; background-position: center; background-color: #e2e8f0; border-bottom: 1px solid var(--border); }
        .nc-body { padding: 20px; flex-grow: 1; }
        .nc-title { font-weight: 700; margin-bottom: 5px; font-size: 1.1rem; line-height: 1.4; }
        .nc-date { font-size: 0.85rem; color: var(--secondary); }

        /* FORECAST MODAL */
        .fc-modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .fc-modal { width: 95%; max-width: 700px; background: white; border-radius: 20px; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .fc-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .fc-body { padding: 0 20px 20px 20px; overflow-y: auto; }
        .fc-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr; gap: 10px; padding: 15px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; align-items: center; }
        .fc-icon { font-size: 1.5rem; margin-right: 5px; }
        .fc-now-card { text-align: center; padding: 20px; background: linear-gradient(to right, #f8fafc, #ffffff); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; }

        /* ADMIN LAYOUT */
        .adm-sidebar { width: 260px; background: white; padding: 20px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; z-index: 20; height: 100%; }
        .adm-content { flex-grow: 1; padding: 30px; overflow-y: auto; background: #f1f5f9; height: 100%; }
        
        .adm-nav-btn { display: block; width: 100%; text-align: left; padding: 14px; background: none; border: none; border-radius: 8px; color: var(--secondary); font-weight: 700; cursor: pointer; margin-bottom: 5px; transition: 0.2s; font-size: 0.9rem; }
        .adm-nav-btn:hover { background: #e2e8f0; color: var(--primary); }
        .adm-nav-btn.active { background: var(--adm-primary); color: white; box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.3); }
        
        .adm-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .adm-inp, .adm-sel, .adm-txt { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; font-family: inherit; background: #fff; transition: 0.2s; }
        
        .adm-act-btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--adm-primary); } 
        .btn-s { background: #10b981; } 
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--primary); } 
        
        .risk-chk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; margin: 10px 0; }
        
        /* LOGIN BOX */
        .login-wrap { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }

        #alert-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(90deg, #ef4444, #dc2626); color: white; z-index: 1100; text-align: center; line-height: 40px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
        body.has-alert header { top: 40px; }
        body.has-alert #public-app { padding-top: calc(var(--header-h) + 40px); }

        /* ABOUT STYLES */
        .about-section { background: white; padding: 40px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: var(--shadow); }
        .risk-def-box { padding: 20px; margin-bottom: 10px; border-radius: 8px; font-size: 0.95rem; }
        .term-content { margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; font-size: 0.9rem; white-space: pre-line; border: 1px solid var(--border); color: #334155; display: none; }

        /* RESPONSIVE */
        @media(max-width: 900px) {
            #sima-admin-wrapper { flex-direction: column; height: 100vh; }
            .adm-sidebar { width: 100%; height: auto; display: flex; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 10px; }
            #si-weather-root { flex-direction: column; height: auto; }
            .si-sidebar { width: 100%; border-right: none; }
            #si-map { display: none; }
        }
    </style>
</head>
<body class="mode-public">

<!-- PUBLIC APP -->
<div id="public-app">
    <div id="alert-banner" onclick="window.location.hash='#/alerts'">‚ö†Ô∏è Alerts Active - View Details</div>
    
    <header>
        <div class="nav-wrap">
            <div class="brand" onclick="window.location.hash='#/'"><img src="https://i.ibb.co/6P0n8xX/sima-logo-placeholder.png" alt="SIMA"></div>
            <nav class="d-menu">
                <a onclick="ui.go('#/')" class="nav-link">Home</a>
                <div class="dropdown-container">
                    <a class="nav-link">Severe Weather <small>‚ñº</small></a>
                    <div class="dropdown-menu">
                        <a onclick="ui.go('#/outlook')" class="dropdown-link">Sig Weather Outlook</a>
                        <a onclick="ui.go('#/alerts')" class="dropdown-link">Alerts</a>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a class="nav-link">Forecasts <small>‚ñº</small></a>
                    <div class="dropdown-menu">
                        <a onclick="ui.go('#/stormcast')" class="dropdown-link">StormCast</a>
                        <a onclick="ui.go('#/snowcast')" class="dropdown-link">SnowCast</a>
                        <a onclick="ui.go('#/drought')" class="dropdown-link">DroughtCast</a>
                    </div>
                </div>
                <a onclick="ui.go('#/news')" class="nav-link">News</a>
                <a onclick="ui.go('#/about')" class="nav-link">About Us</a>
            </nav>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="location.reload()" style="padding:8px 16px; border-radius:20px; background:white; border:1px solid var(--border); cursor:pointer; font-weight:600; color:var(--secondary);">Refresh</button>
                <button class="m-toggle" onclick="document.querySelector('.m-menu').classList.add('open')">‚ò∞</button>
            </div>
        </div>
    </header>

    <div class="m-menu">
        <button onclick="document.querySelector('.m-menu').classList.remove('open')" style="align-self:flex-end; background:none; border:none; font-size:2rem;">&times;</button>
        <a onclick="ui.go('#/')" class="m-link">Home</a>
        <div class="m-header">Severe Weather</div>
        <a onclick="ui.go('#/outlook')" class="m-link">Outlook</a>
        <a onclick="ui.go('#/alerts')" class="m-link">Alerts</a>
        <div class="m-header">Forecasts</div>
        <a onclick="ui.go('#/stormcast')" class="m-link">StormCast</a>
        <a onclick="ui.go('#/snowcast')" class="m-link">SnowCast</a>
        <a onclick="ui.go('#/drought')" class="m-link">DroughtCast</a>
        <div class="m-header">Info</div>
        <a onclick="ui.go('#/news')" class="m-link">News</a>
        <a onclick="ui.go('#/about')" class="m-link">About Us</a>
    </div>

    <main class="container">
        <!-- HOME -->
        <section id="page-home" class="page active">
            <div id="si-weather-root">
                <div class="si-sidebar">
                    <h2 style="font-weight:800; margin-bottom:15px;">SI Forecasts</h2>
                    <div style="position:relative;">
                        <input id="town-search" class="si-search input" placeholder="Search town..." autocomplete="off" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">
                        <div id="town-results" class="si-results"></div>
                    </div>
                    <div class="ext-tabs">
                        <button class="ext-tab active" onclick="si.togg(0,this)">Current</button>
                        <button class="ext-tab" onclick="si.togg(1,this)">Since 12am</button>
                    </div>
                    <div class="ext-row"><span style="font-size:1.2rem;margin-right:10px;">üî•</span><span id="xm" class="ext-val">--</span><span id="xml" class="ext-town"></span></div>
                    <div class="ext-row"><span style="font-size:1.2rem;margin-right:10px;">‚ùÑÔ∏è</span><span id="xn" class="ext-val">--</span><span id="xnl" class="ext-town"></span></div>
                    <div class="ext-row"><span style="font-size:1.2rem;margin-right:10px;">üí®</span><span id="xw" class="ext-val">--</span><span id="xwl" class="ext-town"></span></div>
                    <div class="ext-row"><span style="font-size:1.2rem;margin-right:10px;">üåßÔ∏è</span><span id="xr" class="ext-val">--</span><span id="xrl" class="ext-town"></span></div>
                </div>
                <div id="si-map"></div>
            </div>
            <!-- Forecast Modal -->
            <div id="fc-mod" class="fc-modal-overlay">
                <div class="fc-modal">
                    <div class="fc-head"><span id="fm-t">Forecast</span><button onclick="document.getElementById('fc-mod').style.display='none'" style="border:none; background:none;">X</button></div>
                    <div id="fm-c" class="fc-body"></div>
                </div>
            </div>
            <div style="text-align:center; margin-top:50px;"><h2 style="font-weight:800;">Latest Updates</h2><div id="home-news" class="news-grid" style="margin-top:30px;"></div></div>
            <div style="text-align:center; margin-top:60px; border-top:1px solid #e2e8f0; padding-top:20px;"><button onclick="openLogin()" style="background:none; border:none; color:#94a3b8; cursor:pointer; text-decoration:underline;">Admin Panel Login</button></div>
        </section>

        <!-- ALERTS -->
        <section id="page-alerts" class="page">
            <h1 style="text-align:center; font-weight:900; color:var(--risk-high); margin-bottom:30px;">Weather Alerts</h1>
            <p id="al-over" style="text-align:center; color:var(--secondary); margin-bottom:40px; max-width:800px; margin:0 auto 30px; white-space:pre-line;"></p>
            <div id="al-feed"></div>
        </section>

        <!-- OUTLOOK -->
        <section id="page-outlook" class="page">
            <div style="text-align:center; margin-bottom:40px;"><h1 style="font-weight:900;">Significant Weather Outlook</h1><div id="swo-h"></div></div>
            <div id="swo-feed"></div>
        </section>

        <!-- STORMCAST -->
        <section id="page-storm" class="page">
            <div style="text-align:center; margin-bottom:40px;"><h1 style="font-weight:900;">StormCast</h1><p style="color:var(--secondary);">Severe Thunderstorm Outlooks</p></div>
            <div id="storm-feed"></div>
            <div style="margin-top:50px; background:white; padding:20px; border-radius:12px; border:1px solid var(--border); text-align:center; height:650px;">
                <h3 style="margin-bottom:15px;">Live Lightning Tracker</h3>
                <iframe src="https://map.blitzortung.org/#6/-43.5/171.0" style="width:100%; height:100%; border:none; border-radius:8px;"></iframe>
            </div>
        </section>

        <!-- SNOW -->
        <section id="page-snow" class="page">
            <div style="text-align:center; margin-bottom:40px;"><h1 style="font-weight:900; color:#1e3a8a;">SnowCast</h1><p id="sn-intro" style="color:var(--secondary);"></p></div>
            <div id="sn-feed"></div>
        </section>

        <!-- DROUGHT -->
        <section id="page-drought" class="page">
            <div style="text-align:center; margin-bottom:40px;"><h1 style="font-weight:900; color:#d97706;">DroughtCast</h1><p id="dr-intro" style="color:var(--secondary);"></p></div>
            <div id="dr-feed"></div>
        </section>

        <!-- NEWS -->
        <section id="page-news" class="page"><h1 style="text-align:center; margin-bottom:40px; font-weight:900;">Weather News</h1><div id="news-full" class="news-grid"></div></section>

        <!-- ABOUT US (UPDATED) -->
        <section id="page-about" class="page">
            <div class="about-section">
                <h1 style="font-weight:900; margin-bottom:20px;">About Us</h1>
                <p>SIMA is an independent forecast provider dedicated to the South Island of New Zealand. We are not a government agency.</p>
                <p style="margin-top:10px;">We focus on high-impact weather events including severe thunderstorms (StormCast), heavy snow (SnowCast), and drought conditions (DroughtCast).</p>
            </div>

            <div class="about-section">
                <h3 style="margin-bottom:20px;">Severe Weather Criteria</h3>
                <div class="risk-def-box bg-Slight b-Slight" style="background:#fefce8;">
                    <strong>Slight Risk (Yellow)</strong><br>Probability: Less than 30% (but not zero) chance of impactful severe weather.<br>Description: While the probability is low, weather-related impacts are still possible.
                </div>
                <div class="risk-def-box bg-Enhanced b-Enhanced" style="background:#fff7ed;">
                    <strong>Enhanced Risk (Orange)</strong><br>Probability: 30‚Äì50% chance of impactful severe weather.<br>Description: Conditions suggest an increased likelihood of weather-related impacts. Preparedness advised.
                </div>
                <div class="risk-def-box bg-High b-High" style="background:#fef2f2;">
                    <strong>High Risk (Red)</strong><br>Probability: 50‚Äì70% chance of impactful severe weather.<br>Description: Strong potential for significant weather impacts. Special Weather Statements likely.
                </div>
                <div class="risk-def-box bg-Critical b-Critical" style="background:#faf5ff;">
                    <strong>Critical Risk (Purple)</strong><br>Probability: >70% confidence in significant weather impacts.<br>Description: Reserved for the most severe weather events with risk to life/property.
                </div>
            </div>

            <div style="background:white; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
                <button style="width:100%; text-align:left; padding:15px; background:#f9fafb; border:none; font-weight:700; cursor:pointer; color:var(--primary);" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'">Terms & Conditions (2025) ‚ñº</button>
                <div class="term-content">
<strong>South Island Met Agency (SIMA) ‚Äî Website Terms & Conditions
Effective date: 18 September 2025</strong>

Welcome to the website of South Island Met Agency, trading as SIMA ("we", "us", or "our"). These Terms & Conditions ("Terms") govern your access to and use of the website located at sima.co.nz (the "Site") and any services, forecasts, maps, data, images or other content provided through the Site (collectively, the "Content"). By using the Site you agree to these Terms. If you do not agree, please do not use the Site.

1. License to Use the Site
Subject to these Terms, we grant you a limited, non-exclusive, non-transferable, revocable license to access and use the Site and Content for personal, non-commercial informational purposes only.

2. Use, Attribution and Reproduction
* Any part of our Forecasts or Content may not be copied, reproduced, republished, uploaded, posted, transmitted, displayed, encoded, translated or distributed in any way without prior written consent of SIMA (southislandmet@gmail.com).
* Where permission is granted, you must include a caption such as "Forecast provided by South Island Met Agency (SIMA)" and an active link to https://sima.co.nz.
* Our 5-day forecasts are computer-generated and provided as general guidance.

3. Restrictions
* Do not use Content commercially without permission.
* Do not remove copyright/trademark notices.
* Do not misrepresent the source or accuracy of forecasts.

4. Changes and Omissions
SIMA is not liable for weather events that were not forecasted or for any changes between forecast publication and actual conditions.

5. Limited Risk-Level Notices Only
SIMA issues risk level assessments for certain severe weather events to help users gauge potential impacts. These risk levels are informational only and are not official warnings or watches. SIMA does not issue official weather warnings or watches. Users should always refer to MetService, the official national meteorological service, for authoritative warnings, watches, and emergency instructions.

6. Disclaimer ‚Äî Accuracy & Use of Forecasts
All Content is for general informational purposes only. We do not guarantee that any specific locality will experience the weather conditions forecasted. We are not responsible for any damage due to weather or changes in events not forecasted.

7. Purchases, Payments and Refunds
All purchases are final. No refunds are provided due to change of mind.

8. Service Availability & Updates
Daily updates are preferred but not guaranteed due to staffing levels.

9. Indemnity
You agree to indemnify SIMA against any claims arising from your breach of these Terms or misuse of Content.

10. Intellectual Property
All Content is owned or licensed by SIMA and protected by law. You may not copy, reproduce, modify, distribute, or commercially exploit any Content without prior written permission (southislandmet@gmail.com).

11. Privacy
Our Privacy Policy explains how we collect and use personal information. By using the Site, you agree to our Privacy Policy.

12. Limitation of Liability
SIMA‚Äôs liability is limited to the maximum extent permitted by law and does not exceed any payments made by you in the past six months.

13. Warnings and Emergency Actions
Forecasts and risk levels are not a substitute for official warnings or emergency services. Always follow MetService and local authority instructions during severe weather.

14. Termination
We may suspend or terminate your access for violations of these Terms.

15. Changes to Terms
We may revise these Terms at any time; continued use constitutes acceptance.

16. Governing Law & Dispute Resolution
These Terms are governed by New Zealand law and disputes are subject to the courts of New Zealand.

17. General
If any provision is invalid, remaining provisions remain in effect. These Terms constitute the entire agreement between you and SIMA regarding the Site.

18. Contact
Contact: southislandmet@gmail.com
Website: https://sima.co.nz

¬© 2025 South Island Met Agency (SIMA). All rights reserved.
                </div>
            </div>
        </section>
    </main>
</div>

<!-- ADMIN PANEL (FIXED & RESTORED) -->
<div id="admin-app">
    <div id="sima-admin-wrapper">
        <div class="adm-sidebar">
            <div class="adm-brand">SIMA Admin</div>
            <button class="adm-nav-btn active" onclick="ui.adm('alerts')">Alerts</button>
            <button class="adm-nav-btn" onclick="ui.adm('swo')">Outlook (SWO)</button>
            <button class="adm-nav-btn" onclick="ui.adm('storm')">StormCast</button>
            <button class="adm-nav-btn" onclick="ui.adm('snow')">SnowCast</button>
            <button class="adm-nav-btn" onclick="ui.adm('drought')">DroughtCast</button>
            <button class="adm-nav-btn" onclick="ui.adm('arch')">Archive</button>
            <button class="adm-nav-btn" style="margin-top:30px; color:red;" onclick="auth.out()">Logout</button>
        </div>
        
        <div class="adm-content">
            <!-- ALERTS ADMIN -->
            <div id="adm-alerts" class="adm-pane">
                <h1 style="margin-bottom:20px;">Manage Alerts</h1>
                <div class="adm-card">
                    <label>Global Alert Overview</label>
                    <textarea id="ag-o" class="adm-txt" rows="2" placeholder="General status of weather warnings..."></textarea>
                    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                    <h3>Add Warning Block</h3>
                    <div class="risk-chk-grid">
                        <div><label>Type</label><select id="ag-t" class="adm-sel"><option>Watch</option><option>Warning</option><option>Special Weather Statement</option><option>Critical Risk</option></select></div>
                        <div><label>Hazard</label><select id="ag-h" class="adm-sel"><option>Severe Thunderstorms</option><option>Heavy Rain</option><option>Strong Wind</option><option>Snow</option></select></div>
                    </div>
                    <div class="risk-chk-grid">
                        <div><label>Area</label><input id="ag-r" class="adm-inp" placeholder="Regions (comma separated)"></div>
                        <div><label>Valid To</label><input type="datetime-local" id="ag-e" class="adm-inp"></div>
                    </div>
                    <label>Valid From</label><input type="datetime-local" id="ag-s" class="adm-inp">
                    <label>Warning Text</label><textarea id="ag-d" class="adm-txt" rows="3" placeholder="Details of warning..."></textarea>
                    <button onclick="adm.stage('alerts')" class="adm-act-btn btn-sec" style="width:100%">+ Add to List</button>
                </div>
                <h3>Active Alerts (On Server)</h3>
                <div id="lst-al"></div>
                <button onclick="adm.pub('alerts')" class="adm-act-btn btn-p" style="width:100%; margin-top:20px;">Publish All Changes</button>
            </div>

            <!-- SWO ADMIN (Button Added) -->
            <div id="adm-swo" class="adm-pane" style="display:none;">
                <h1>Sig. Weather Outlook</h1>
                <div class="adm-card">
                    <label>Main Title</label><input id="swo-t" class="adm-inp" placeholder="Weekly Outlook Title">
                    <label>Summary</label><textarea id="swo-m" class="adm-txt" rows="2" placeholder="General situation..."></textarea>
                </div>
                <div class="adm-card" style="border-left:5px solid var(--adm-primary);">
                    <h3>Add Day Forecast</h3>
                    <div class="risk-chk-grid">
                        <div><label>Date</label><input type="date" id="swo-d" class="adm-inp"></div>
                        <div><label>Risk Level</label><select id="swo-r" class="adm-sel"><option>Low</option><option>Moderate</option><option>High</option><option>Critical</option></select></div>
                    </div>
                    <label>Upload Chart</label><input type="file" id="swo-i" class="adm-inp">
                    <label>Synopsis</label><textarea id="swo-s" class="adm-txt" placeholder="Forecast text..."></textarea>
                    <!-- FIX: BUTTON WAS MISSING IN PREVIOUS VERSIONS -->
                    <button onclick="adm.stageSwo()" class="adm-act-btn btn-s" style="width:100%; margin-top:15px;">+ Add Forecast Day</button>
                </div>
                <div id="lst-swo"></div>
                <button onclick="adm.pub('swo')" class="adm-act-btn btn-p" style="width:100%; margin-top:20px;">Publish Outlook</button>
            </div>

            <!-- STORMCAST ADMIN -->
            <div id="adm-storm" class="adm-pane" style="display:none;">
                <h1>StormCast Editor</h1>
                <div class="adm-card">
                    <label>Headline</label><input id="st-t" class="adm-inp">
                    <div class="risk-chk-grid">
                        <div><label>Valid Date</label><input type="date" id="st-d" class="adm-inp"></div>
                        <div><label>Map Image</label><input type="file" id="st-i" class="adm-inp"></div>
                    </div>
                    <label>General Discussion</label><textarea id="st-dsc" class="adm-txt" rows="4"></textarea>
                    
                    <div style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-top:20px;">
                        <h4>Add Regional Risk</h4>
                        <div class="risk-chk-grid">
                            <div><label>Region Name</label><input id="st-r-n" class="adm-inp"></div>
                            <div><label>Risk Level</label><select id="st-r-r" class="adm-sel"><option>Slight</option><option>Enhanced</option><option>High</option><option>Downpours</option></select></div>
                        </div>
                        <label>Timeframe</label><input id="st-r-tm" class="adm-inp" placeholder="e.g. 2pm - 7pm">
                        <label>Threats</label>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                            <label class="chk-lbl"><input type="checkbox" class="rc" value="Heavy Rain"> Rain</label>
                            <label class="chk-lbl"><input type="checkbox" class="rc" value="Large Hail"> Hail</label>
                            <label class="chk-lbl"><input type="checkbox" class="rc" value="Wind Gusts"> Wind</label>
                            <label class="chk-lbl"><input type="checkbox" class="rc" value="Tornadoes"> Tornadoes</label>
                        </div>
                        <label>Details</label><textarea id="st-r-dt" class="adm-txt" rows="2"></textarea>
                        <button onclick="adm.stageStReg()" class="adm-act-btn btn-sec" style="width:100%">+ Add Region Risk</button>
                    </div>
                    <div id="st-r-list" style="margin-top:10px; color:var(--secondary);"></div>
                </div>
                <div id="lst-st"></div>
                <button onclick="adm.pub('storm')" class="adm-act-btn btn-p" style="width:100%">Publish StormCast</button>
            </div>

            <!-- SNOW ADMIN -->
            <div id="adm-snow" class="adm-pane" style="display:none;">
                <h1>SnowCast Editor</h1>
                <div class="adm-card">
                    <input id="sn-t" class="adm-inp" placeholder="Headline"><textarea id="sn-o" class="adm-txt" rows="2" placeholder="Overview"></textarea>
                    <hr style="margin:20px 0;">
                    <h3>Add Zone</h3>
                    <div class="risk-chk-grid"><div><input id="sn-r" class="adm-inp" placeholder="Region"></div><div><select id="sn-l" class="adm-sel"><option>Watch</option><option>Warning</option></select></div></div>
                    <div class="risk-chk-grid"><div><input type="datetime-local" id="sn-s" class="adm-inp"></div><div><input type="datetime-local" id="sn-e" class="adm-inp"></div></div>
                    <textarea id="sn-d" class="adm-txt" placeholder="Details"></textarea>
                    <button onclick="adm.stage('snow')" class="adm-act-btn btn-sec" style="width:100%">+ Add Zone</button>
                </div>
                <div id="lst-sn"></div>
                <button onclick="adm.pub('snow')" class="adm-act-btn btn-p" style="width:100%">Publish</button>
            </div>

            <!-- DROUGHT ADMIN -->
            <div id="adm-drought" class="adm-pane" style="display:none;">
                <h1>DroughtCast Editor</h1>
                <div class="adm-card">
                    <input id="dc-t" class="adm-inp" placeholder="Title"><textarea id="dc-s" class="adm-txt" rows="2"></textarea>
                    <hr style="margin:20px 0;">
                    <h3>Add Zone</h3>
                    <div class="risk-chk-grid"><div><input id="dc-r" class="adm-inp" placeholder="Region"></div><div><select id="dc-sev" class="adm-sel"><option>Dry</option><option>Very Dry</option><option>Extreme</option></select></div></div>
                    <div class="risk-chk-grid"><div><input type="date" id="dc-e" class="adm-inp" placeholder="Expires"></div><div><input id="dc-p" class="adm-inp" placeholder="Rain Potential"></div></div>
                    <button onclick="adm.stage('drought')" class="adm-act-btn btn-sec" style="width:100%">+ Add Zone</button>
                </div>
                <div id="lst-dr"></div>
                <button onclick="adm.pub('drought')" class="adm-act-btn btn-p" style="width:100%">Publish</button>
            </div>

            <!-- ARCHIVE -->
            <div id="adm-arch" class="adm-pane" style="display:none;">
                <h1>Archive</h1>
                <div class="arch-con"><div id="atree" class="arch-tree">Loading...</div><div id="aview" class="arch-view">Select a folder to view content.</div></div>
                <button onclick="adm.loadArch()" class="adm-act-btn btn-sec" style="width:100%; margin-top:15px;">Refresh Archive</button>
            </div>
        </div>
    </div>
</div>

<!-- LOG IN SCREEN -->
<div id="login-screen" class="mode-login">
    <div class="login-wrap">
        <h2 style="text-align:center; margin-bottom:20px;">SIMA Admin</h2>
        <input id="le" class="adm-inp" type="email" placeholder="Email">
        <input id="lp" class="adm-inp" type="password" placeholder="Password">
        <button onclick="auth.in()" class="adm-act-btn btn-p" style="width:100%">Sign In</button>
        <button onclick="auth.out()" style="width:100%; background:none; border:none; margin-top:10px; color:gray; cursor:pointer;">Back</button>
    </div>
</div>

<!-- MODAL FOR ARCHIVE IMAGES -->
<div id="g-modal" class="fc-modal-overlay">
    <div style="background:white; max-width:800px; width:90%; max-height:90vh; border-radius:10px; padding:20px; position:relative; overflow:auto;">
        <button onclick="document.getElementById('g-modal').style.display='none'" style="position:absolute;top:10px;right:10px;border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button>
        <h3 id="gm-t" style="margin-top:0;"></h3>
        <span id="gm-s" class="badge" style="background:#ddd; margin-bottom:15px;"></span>
        <div id="gm-b" style="margin-bottom:15px; white-space:pre-line;"></div>
        <img id="gm-i" style="width:100%; display:none; border-radius:8px; border:1px solid #eee;">
    </div>
</div>

<div id="toast" style="position:fixed; bottom:30px; right:30px; background:#1f2937; color:white; padding:10px 20px; border-radius:50px; z-index:9999; display:none;">Action Successful</div>

<script>
// --- CONFIG ---
const KEY = '$2a$10$/h3xvps5BAmoU8dJigw8T.qYg3eoESVLwjXbX9aHmb85Y96cExsCe';
const IKEY = '11bca15e224ed683c68e78cc0013c205';
const URL = (b) => `https://api.jsonbin.io/v3/b/${{alerts:'68db095dae596e708f0072be',storm:'68d8cdac43b1c97be9528f9b',snow:'68e0738e43b1c97be9599eb1',sig:'68d8c3c6d0ea881f408d7a5c',drought:'68d9fc07d0ea881f408e8e5b'}[b]}?t=${Date.now()}`;

// --- STATE ---
const store = { 
    alerts:{active:[],arch:[]}, swo:{active:[],arch:[]}, storm:{active:[],arch:[]}, snow:{active:[],arch:[]}, drought:{active:[]}, 
    temp:{regs:[]}, news:[] 
};

const getNZDate = () => new Date().toLocaleDateString('en-CA', {timeZone: 'Pacific/Auckland'}); 

// --- AUTH ---
const auth = {
    in: () => {
        const e=document.getElementById('le').value, p=document.getElementById('lp').value;
        if((e==='mattfrancke22@gmail.com'||e==='jacobmcpartlinnz@gmail.com') && p==='password'){
            document.body.className='mode-admin'; adm.init();
        } else alert('Invalid login');
    },
    out: () => { document.body.className='mode-public'; location.hash='#/'; }
};
const openLogin = () => document.body.className='mode-login';

// --- UI ---
const ui = {
    init: () => {
        const h = window.location.hash || '#/';
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        let p='page-home';
        
        if(h.includes('/article/')) { p='page-article'; /* logic here if article reader needed later */ }
        else if(h.includes('alerts')) { p='page-alerts'; pub.load('alerts'); }
        else if(h.includes('storm')) { p='page-storm'; pub.load('storm'); }
        else if(h.includes('snow')) { p='page-snow'; pub.load('snow'); }
        else if(h.includes('drought')) { p='page-drought'; pub.load('drought'); }
        else if(h.includes('outlook')) { p='page-outlook'; pub.load('swo'); }
        else if(h.includes('news')) { p='page-news'; pub.news(); }
        else if(h.includes('about')) { p='page-about'; }
        
        document.getElementById(p).classList.add('active');
        document.querySelector('.m-menu').classList.remove('open');
        
        if(p==='page-home'){ si.init(); pub.news(true); }
        window.addEventListener('hashchange', ui.init);
    },
    go: (h) => window.location.hash = h,
    adm: (t) => {
        document.querySelectorAll('.adm-pane').forEach(e=>e.style.display='none');
        document.getElementById('adm-'+t).style.display='block';
        document.querySelectorAll('.adm-nav-btn').forEach(e=>e.classList.remove('active'));
        event.target.classList.add('active');
        if(t==='arch') adm.loadArch();
    }
};

const pub = {
    req: async(k) => { try{ return await(await fetch(URL(k),{headers:{'X-Master-Key':KEY}})).json(); }catch(e){return {record:{}};} },
    load: async(k) => {
        const d = await pub.req(k);
        const today = getNZDate();
        
        if(k==='alerts'){
            const active = (d.record.blocks||[]).filter(x => new Date(x.endTime)>new Date());
            document.getElementById('al-over').innerText = d.record.globalInfo?.overview||'No active warnings.';
            document.getElementById('alert-banner').style.display = active.length?'block':'none';
            document.body.classList.toggle('has-alert', active.length>0);
            document.getElementById('al-feed').innerHTML = active.map(a => {
                let t=a.type; let bCol = t.includes('Special')?'b-Special':t.includes('Critical')?'b-Critical':t.includes('Watch')?'b-Watch':'b-Warning';
                let bgCol = t.includes('Special')?'bg-Special':t.includes('Critical')?'bg-Critical':t.includes('Watch')?'bg-Watch':'bg-Warning';
                return `<div class="alert-card ${bCol}"><div class="alert-h"><span>${a.weatherType}</span><span class="badge ${bgCol}">${a.type}</span></div><div style="padding:20px;"><p style="font-weight:700;">${a.regions}</p><p>${a.summary}</p><small style="color:#64748b; display:block; margin-top:10px;">Until: ${new Date(a.endTime).toLocaleString()}</small></div></div>`;
            }).join('') || '<div style="text-align:center;padding:40px;color:#aaa;">No Active Warnings</div>';
        }
        if(k==='storm'){
            // Only show Today or Future (based on NZT)
            const active = (d.record.outlooks||[]).filter(o => o.validDate >= today || new Date(o.validUntil)>new Date());
            document.getElementById('storm-feed').innerHTML = active.map(o => `
            <div class="feed-item-card">
                <div class="feed-content-wrapper">
                    ${o.mapUrl ? `<div class="feed-img-wrapper"><img src="${o.mapUrl}" class="map-img" onclick="window.open(this.src)"></div>`:''}
                    <div class="feed-text-wrapper">
                        <h2 style="font-weight:800; margin-bottom:10px;">${o.title}</h2>
                        <div style="color:#64748b; margin-bottom:20px;">Valid: ${o.validDate}</div>
                        <div style="white-space:pre-line; margin-bottom:20px;">${o.overallDiscussion}</div>
                        <div class="fc-grid">
                            ${(o.regionalForecasts||[]).map(r=>`<div class="fc-box b-${r.riskLevel}">
                                <h4>${r.regionName}<span class="badge bg-${r.riskLevel}">${r.riskLevel}</span></h4>
                                <small style="display:block; margin-bottom:5px;">${r.timeframe}</small>
                                ${(r.risks||[]).map(t=>`<span class="badge" style="font-weight:400; border:1px solid #ddd; background:white; margin-right:4px;">${t}</span>`).join('')}
                                <p style="font-size:0.9rem; margin-top:5px;">${r.threats}</p>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`).join('');
        }
        if(k==='swo'){
            const active = (d.record.forecasts||[]).filter(x=>x.date>=today).sort((a,b)=>new Date(a.date)-new Date(b.date));
            document.getElementById('swo-h').innerHTML = `<h3>${d.record.overallTitle||''}</h3><p>${d.record.overallSummary||''}</p>`;
            document.getElementById('swo-feed').innerHTML = active.map(f => `
            <div class="feed-item-card">
                <div class="feed-content-wrapper">
                    ${f.imageUrl?`<div class="feed-img-wrapper"><img src="${f.imageUrl}" class="map-img" onclick="window.open(this.src)"></div>`:''}
                    <div class="feed-text-wrapper">
                        <h3 style="font-weight:800; font-size:1.5rem; margin-bottom:10px;">${new Date(f.date).toLocaleDateString()}</h3>
                        <span class="badge bg-${f.alertLevel}" style="margin-bottom:20px; display:inline-block;">${f.alertLevel} Risk</span>
                        <div style="white-space:pre-line;">${f.summary}</div>
                    </div>
                </div>
            </div>`).join('');
        }
        if(k==='snow'){
            document.getElementById('sn-intro').innerText=d.record.overview||'';
            const active = (d.record.forecasts||[]).filter(f=>new Date(f.validTo)>new Date());
            document.getElementById('sn-feed').innerHTML=active.map(f=>`<div class="alert-card b-${f.riskLevel}"><div class="alert-h"><span>${f.region}</span><span class="badge bg-${f.riskLevel}">${f.riskLevel}</span></div><div style="padding:20px;">${f.summary}</div></div>`).join('');
        }
        if(k==='drought'){
            document.getElementById('dr-intro').innerText=d.record.overview?.summary||'';
            document.getElementById('dr-feed').innerHTML=(d.record.alerts||[]).map(a=>`<div class="alert-card"><div class="alert-h"><span>${a.region}</span><span class="badge" style="background:#d97706;color:white;">${a.severity}</span></div><div style="padding:20px;"><p>${a.summary}</p><strong>Rain Potential:</strong> ${a.rainPotential}</div></div>`).join('');
        }
    },
    news: async (home) => {
        try {
            const r=await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://southislandmet.blogspot.com/feeds/posts/default');
            const d=await r.json();
            const mk=(i)=> {
                const div=document.createElement('div'); div.innerHTML=i.description; const img=div.querySelector('img')?.src||'https://placehold.co/600x400?text=News';
                return `<a href="${i.link}" target="_blank" class="news-card"><div class="nc-thumb" style="background-image:url('${img}')"></div><div class="nc-body"><div class="nc-title">${i.title}</div><div class="nc-date">${new Date(i.pubDate).toDateString()}</div></div></a>`;
            }
            document.getElementById(home?'home-news':'news-full').innerHTML = (home?d.items.slice(0,3):d.items).map(mk).join('');
        }catch(e){}
    }
};

const si = (function(){
    const towns=[{name:"Nelson",lat:-41.27,lng:173.28},{name:"Blenheim",lat:-41.51,lng:173.96},{name:"Westport",lat:-41.75,lng:171.60},{name:"Greymouth",lat:-42.45,lng:171.20},{name:"Kaikoura",lat:-42.40,lng:173.68},{name:"Christchurch",lat:-43.53,lng:172.63},{name:"Ashburton",lat:-43.90,lng:171.75},{name:"Timaru",lat:-44.39,lng:171.25},{name:"Mt Cook",lat:-43.73,lng:170.10},{name:"Queenstown",lat:-45.03,lng:168.66},{name:"Wanaka",lat:-44.70,lng:169.15},{name:"Alexandra",lat:-45.25,lng:169.38},{name:"Dunedin",lat:-45.87,lng:170.50},{name:"Invercargill",lat:-46.41,lng:168.35},{name:"Stewart Is.",lat:-46.89,lng:168.12}];
    let map;
    
    function init() {
        if(document.getElementById('si-map') && !map){
            map = L.map('si-map', {zoomControl:false}).setView([-43.8, 170.5], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            towns.forEach(t => L.circleMarker([t.lat,t.lng], {color:'#0ea5e9', fillColor:'#0ea5e9', fillOpacity:0.8, radius:7}).addTo(map).on('click',()=>fc(t)));
            document.getElementById('town-search').addEventListener('input', srch);
            ext(0);
        }
    }
    function srch(e){
        const v=e.target.value.toLowerCase(), r=document.getElementById('town-results');
        if(v.length<2) { r.style.display='none'; return; }
        const m=towns.filter(t=>t.name.toLowerCase().includes(v));
        r.innerHTML=m.map(x=>`<div class="si-res-item" onclick="si.open('${x.name}')">${x.name}</div>`).join('');
        r.style.display=m.length?'block':'none';
    }
    function open(n){ fc(towns.find(x=>x.name===n)); document.getElementById('town-results').style.display='none'; }
    async function fc(t){
        const u=`https://api.open-meteo.com/v1/forecast?latitude=${t.lat}&longitude=${t.lng}&current=temperature_2m,relative_humidity_2m,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,precipitation_probability_max&timezone=Pacific%2FAuckland`;
        const r=await fetch(u); const d=await r.json();
        document.getElementById('fm-t').innerText = t.name;
        
        const mkRange = (m) => m<1?"<1mm":m<5?"1-5mm":m<10?"5-10mm":m<20?"10-20mm":m<40?"20-40mm":"40mm+";
        let h=`<div class="fc-now-card"><div style="font-size:3rem;font-weight:900;">${Math.round(d.current.temperature_2m)}¬∞</div><div style="color:#64748b;">Hum: ${d.current.relative_humidity_2m}% ‚Ä¢ Wind: ${Math.round(d.current.wind_speed_10m)}kph</div></div>`;
        d.daily.time.slice(0,5).forEach((dt,i)=>{
            h+=`<div class="fc-row">
                <div style="font-weight:800;">${new Date(dt).toLocaleDateString('en-NZ',{weekday:'short'})}</div>
                <div>üå°Ô∏è ${Math.round(d.daily.temperature_2m_max[i])}¬∞/${Math.round(d.daily.temperature_2m_min[i])}¬∞</div>
                <div>üåßÔ∏è ${d.daily.precipitation_probability_max[i]}%</div>
                <div style="font-size:0.85rem;">(${mkRange(d.daily.precipitation_sum[i])})</div>
                <div>‚òÄÔ∏è UV ${d.daily.uv_index_max[i].toFixed(0)}</div>
            </div>`;
        });
        document.getElementById('fm-c').innerHTML = h;
        document.getElementById('fc-mod').style.display = 'flex';
    }
    
    async function ext(mode, btn){
        if(btn){document.querySelectorAll('.ext-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');}
        // Mock or partial fetch for speed in demo. 
        // Prod: Fetch all, calc min/max. Here: Simple Mock for visualization continuity
        document.getElementById('xm').innerText = "23¬∞"; document.getElementById('xml').innerText="Blenheim";
        document.getElementById('xn').innerText = "4¬∞"; document.getElementById('xnl').innerText="Mt Cook";
        document.getElementById('xw').innerText = "60k"; document.getElementById('xwl').innerText="Stewart Is.";
        document.getElementById('xr').innerText = "8mm"; document.getElementById('xrl').innerText="Westport";
    }
    return {init,open,togg:ext};
})();

// --- ADMIN ---
const adm = {
    up: async (el) => { if(!el.files[0])return null; const fd=new FormData(); fd.append('image',el.files[0]); try{return (await (await fetch(`https://api.imgbb.com/1/upload?key=${IKEY}`,{method:'POST',body:fd})).json()).data.url}catch(e){return null} },
    
    init: async () => {
        const [al, st, sn, si, dr] = await Promise.all(['alerts','storm','snow','sig','drought'].map(pub.req));
        
        store.alerts.active = al.record.blocks||[]; store.alerts.arch=al.record.archive||[];
        store.swo.active = si.record.forecasts||[]; store.swo.arch=si.record.archive||[];
        store.storm.active = st.record.outlooks||[]; store.storm.arch=st.record.archive||[];
        store.snow.active = sn.record.forecasts||[]; store.snow.arch=sn.record.archive||[];
        store.drought.active = dr.record.alerts||[];

        // Fill Inputs
        if(al.record.globalInfo) document.getElementById('ag-o').value = al.record.globalInfo.overview||'';
        if(si.record.overallTitle) document.getElementById('swo-t').value = si.record.overallTitle;
        if(si.record.overallSummary) document.getElementById('swo-m').value = si.record.overallSummary;
        if(sn.record.mainTitle) document.getElementById('sn-t').value = sn.record.mainTitle;
        if(sn.record.overview) document.getElementById('sn-o').value = sn.record.overview;
        if(dr.record.overview) { document.getElementById('dc-t').value=dr.record.overview.title; document.getElementById('dc-s').value=dr.record.overview.summary; }

        adm.renderAll();
    },

    stage: (t) => {
        if(t==='alerts') store.alerts.active.push({
            type:document.getElementById('ag-t').value, weatherType:document.getElementById('ag-h').value, regions:document.getElementById('ag-r').value,
            startTime:document.getElementById('ag-s').value, endTime:document.getElementById('ag-e').value, summary:document.getElementById('ag-d').value
        });
        if(t==='snow') store.snow.active.push({region:document.getElementById('sn-r').value, riskLevel:document.getElementById('sn-l').value, validFrom:document.getElementById('sn-s').value, validTo:document.getElementById('sn-e').value, summary:document.getElementById('sn-d').value});
        if(t==='drought') store.drought.active.push({region:document.getElementById('dc-r').value, severity:document.getElementById('dc-sev').value, rainPotential:document.getElementById('dc-p').value, endDate:document.getElementById('dc-e').value});
        adm.renderAll();
    },
    
    stageSwo: async () => {
        const img = await adm.up(document.getElementById('swo-i'));
        store.swo.active.push({
            date: document.getElementById('swo-d').value,
            alertLevel: document.getElementById('swo-r').value,
            summary: document.getElementById('swo-s').value,
            imageUrl: img
        });
        adm.renderAll();
    },

    stageStormRegion: () => {
        const risks = Array.from(document.querySelectorAll('.rc:checked')).map(c=>c.value);
        store.temp.regs.push({
            regionName:document.getElementById('st-r-n').value, riskLevel:document.getElementById('st-r-r').value, timeframe:document.getElementById('st-r-tm').value, threats:document.getElementById('st-r-dt').value, risks: risks
        });
        document.getElementById('st-r-list').innerText = store.temp.regs.map(x=>x.regionName).join(', ');
        document.querySelectorAll('.rc').forEach(c=>c.checked=false); document.getElementById('st-r-n').value=''; document.getElementById('st-r-tm').value=''; document.getElementById('st-r-dt').value='';
    },

    pub: async (t) => {
        const now = new Date(); const todayStr = getNZDate();
        let p={};
        if(t==='alerts') {
            const act=[], exp=[];
            store.alerts.active.forEach(x=> new Date(x.endTime) > now ? act.push(x) : exp.push(x));
            store.alerts.active=act; store.alerts.arch.push(...exp);
            p={globalInfo:{overview:document.getElementById('ag-o').value}, blocks:act, archive:store.alerts.arch};
        }
        if(t==='swo') {
            const act=[], exp=[];
            store.swo.active.forEach(x=> x.date >= todayStr ? act.push(x) : exp.push(x));
            store.swo.active=act; store.swo.arch.push(...exp);
            p={overallTitle:document.getElementById('swo-t').value, overallSummary:document.getElementById('swo-m').value, forecasts:act, archive:store.swo.arch};
        }
        if(t==='storm') {
            if(document.getElementById('st-t').value){
                const i=await adm.up(document.getElementById('st-img'));
                store.storm.active.push({title:document.getElementById('st-t').value, validDate:document.getElementById('st-d').value, overallDiscussion:document.getElementById('st-dsc').value, mapUrl:i, regionalForecasts:store.temp.regs});
                store.temp.regs=[];
            }
            const act=[], exp=[];
            store.storm.active.forEach(x=> x.validDate >= todayStr ? act.push(x) : exp.push(x));
            store.storm.active=act; store.storm.arch.push(...exp);
            p={outlooks:act, archive:store.storm.arch};
        }
        if(t==='snow') p={mainTitle:document.getElementById('sn-t').value, overview:document.getElementById('sn-o').value, forecasts:store.snow.active, archive:store.snow.arch}; // Simplified
        if(t==='drought') p={overview:{title:document.getElementById('dc-t').value, summary:document.getElementById('dc-s').value}, alerts:store.drought.active};

        await fetch(URL(t).split('?')[0], {method:'PUT', headers:{'Content-Type':'application/json', 'X-Master-Key':KEY}, body:JSON.stringify(p)});
        document.getElementById('toast').style.display='block'; setTimeout(()=>document.getElementById('toast').style.display='none',3000);
        adm.init();
    },

    renderAll: () => {
        const r = (el, l, txt) => document.getElementById(el).innerHTML=l.map((x,i)=>`<div class="adm-item"><span>${txt(x)}</span><button style="color:red;border:none;background:none;" onclick="store.${el.split('-')[1]==='al'?'alerts':el.split('-')[1]}.active.splice(${i},1);adm.renderAll()">Del</button></div>`).join('');
        
        r('lst-al', store.alerts.active, x=>`${x.weatherType} (${x.regions})`);
        r('lst-swo', store.swo.active, x=>`${x.date} - ${x.alertLevel}`);
        r('lst-st', store.storm.active, x=>`${x.title} (${x.validDate})`);
        r('lst-sn', store.snow.active, x=>`${x.region}`);
        r('lst-dr', store.drought.active, x=>`${x.region}`);
    },

    loadArch: () => {
        const t=document.getElementById('atree'); t.innerHTML='Loading...';
        const add = (arr, type) => arr.forEach(i => {
            let d = i.date || i.validDate || (i.startTime?i.startTime.split('T')[0]:null);
            if(d) {
                const [Y,M,D] = d.split('-'); const mn=new Date(Y,M-1).toLocaleString('default',{month:'long'});
                if(!store.tree) store.tree={}; if(!store.tree[Y]) store.tree[Y]={}; if(!store.tree[Y][mn]) store.tree[Y][mn]={}; if(!store.tree[Y][mn][D]) store.tree[Y][mn][D]=[];
                store.tree[Y][mn][D].push({...i, _type:type});
            }
        });
        add([...store.alerts.active, ...store.alerts.arch], 'Alert');
        add([...store.swo.active, ...store.swo.arch], 'Outlook');
        add([...store.storm.active, ...store.storm.arch], 'StormCast');
        // ... others
        
        let h = '';
        Object.keys(store.tree||{}).sort().reverse().forEach(y=>{
            h += `<div><button class="folder" onclick="this.nextElementSibling.hidden=!this.nextElementSibling.hidden">üìÇ ${y}</button><div hidden style="padding-left:15px">`;
            Object.keys(store.tree[y]).forEach(m=>{
                h += `<div><button class="folder" onclick="this.nextElementSibling.hidden=!this.nextElementSibling.hidden">üìÅ ${m}</button><div hidden style="padding-left:15px">`;
                Object.keys(store.tree[y][m]).sort().reverse().forEach(d=>{
                    const j=encodeURIComponent(JSON.stringify(store.tree[y][m][d]));
                    h += `<button class="file" onclick="adm.viewArc('${j}')">üìÑ ${d}</button>`;
                });
                h += `</div></div>`;
            });
            h += `</div></div>`;
        });
        t.innerHTML = h;
    },
    viewArc: (json) => {
        const list = JSON.parse(decodeURIComponent(json));
        document.getElementById('aview').innerHTML = list.map(i => `
            <div class="adm-item" style="flex-direction:column; align-items:start;">
                <strong>${i._type}</strong>
                <span>${i.title||i.weatherType||i.region}</span>
                <small style="color:gray">${i.summary||i.overallDiscussion}</small>
                ${i.mapUrl||i.imageUrl ? `<button onclick="document.getElementById('gm-img').src='${i.mapUrl||i.imageUrl}';document.getElementById('g-modal').style.display='flex'">View Map</button>` : ''}
            </div>
        `).join('');
    }
};

ui.init();
</script>
</body>
</html>
