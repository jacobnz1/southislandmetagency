<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>South Island Meteorological Agency</title>
    
    <!-- GOOGLE ADSENSE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8263002259646510" crossorigin="anonymous"></script>

    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================
           THEME VARIABLES
           ========================= */
        :root {
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --surface-trans: rgba(255, 255, 255, 0.98);
            --primary: #0f172a;
            --secondary: #64748b;
            --accent: #0ea5e9;
            --border: #e2e8f0;
            
            /* Risk Colors */
            --risk-slight: #eab308;    
            --risk-enhanced: #f97316;  
            --risk-high: #ef4444;      
            --risk-critical: #a855f7;  
            --risk-special: #3b82f6;   
            --risk-downpour: #6366f1; 
            
            /* Admin Vars */
            --adm-primary: #2563eb;
            --adm-bg: #f1f5f9;
            
            --header-h: 70px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--primary); line-height: 1.6; height: 100vh; overflow: hidden; }

        /* MODES */
        #public-app, #admin-app, #login-screen { display: none; width: 100%; height: 100%; }
        body.mode-public #public-app { display: block; }
        body.mode-public { padding-top: var(--header-h); overflow-y: auto; }
        
        body.mode-admin { background-color: #d1d5db; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        body.mode-admin #admin-app { display: flex; width: 100%; height: 100%; }

        body.mode-login { background: #0f172a; display: flex; align-items: center; justify-content: center; overflow-y: auto; }
        body.mode-login #login-screen { display: flex; align-items: center; justify-content: center; width: 100%; }

        /* --- PUBLIC HEADER --- */
        header { background: var(--surface-trans); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; height: var(--header-h); display: flex; align-items: center; }
        .nav-wrap { width: 100%; max-width: 1280px; margin: 0 auto; padding: 0 20px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        .brand img { height: 42px; cursor: pointer; }

        .d-menu { display: none; height: 100%; gap: 20px; align-items: center; }
        @media(min-width: 950px) { .d-menu { display: flex; } }
        
        .nav-link { text-decoration: none; color: var(--secondary); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s; position: relative; display: flex; align-items: center; height: 100%; }
        .nav-link:hover { color: var(--accent); background: rgba(14,165,233,0.05); }
        
        /* Dropdowns */
        .dropdown-container { position: relative; height: 100%; display: flex; align-items: center; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid var(--border); border-top: none; min-width: 220px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); flex-direction: column; border-radius: 0 0 8px 8px; overflow: hidden; }
        .dropdown-container:hover .dropdown-menu { display: flex; }
        .dropdown-link { padding: 12px 20px; text-decoration: none; color: var(--primary); font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
        .dropdown-link:hover { background: #f8fafc; color: var(--accent); padding-left: 25px; }

        /* Mobile Menu */
        .m-toggle { background: none; border: none; font-size: 1.5rem; padding: 5px; cursor: pointer; display: block; }
        @media(min-width: 950px) { .m-toggle { display: none; } }
        .m-menu { position: fixed; top: var(--header-h); right: -100%; width: 280px; height: calc(100vh - var(--header-h)); background: white; border-left: 1px solid var(--border); transition: 0.3s; z-index: 999; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .m-menu.open { right: 0; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        .m-header { font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--secondary); margin-top: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .m-link { text-decoration: none; font-weight: 600; color: var(--primary); font-size: 1rem; padding: 10px 0; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; padding-bottom: 80px; }
        .page { display: none; animation: fade 0.3s ease; }
        .page.active { display: block; }
        @keyframes fade { from{opacity:0} to{opacity:1} }

        /* --- HOME WIDGET --- */
        #si-weather-root { background: white; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; height: 650px; margin-bottom: 40px; overflow: hidden; }
        .si-sidebar { width: 380px; padding: 30px; background: white; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
        #si-map { flex-grow: 1; background: #e2e8f0; z-index: 1; }
        .si-search input { width: 100%; padding: 12px 40px 12px 15px; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; font-family: inherit; }
        .si-results { position: absolute; background: white; border: 1px solid var(--border); width: 100%; max-height: 200px; overflow-y: auto; border-radius: 8px; margin-top: 5px; display: none; z-index: 500; box-shadow: var(--shadow); }
        .si-res-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .si-res-item:hover { background: #f0f9ff; color: var(--accent); }
        
        .ext-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 15px; margin-top: 20px; }
        .ext-tab { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.8rem; font-weight: 700; color: var(--secondary); cursor: pointer; border-radius: 6px; }
        .ext-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ext-row { display: flex; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
        .ext-icon { width: 40px; height: 40px; background: #f0f9ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2rem; }
        .ext-val { font-weight: 800; font-size: 1.1rem; display: block; }
        .ext-label { font-size: 0.75rem; color: var(--secondary); text-transform: uppercase; font-weight: 700; }
        .ext-town { font-weight: 400; color: var(--primary); margin-left: 5px; }

        /* --- FEED CARDS (Layout) --- */
        .feed-item-card { background: white; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 30px; overflow: hidden; box-shadow: var(--shadow); }
        
        /* Desktop Flex */
        @media (min-width: 900px) {
            .feed-flex { display: flex; align-items: stretch; }
            .feed-img-box { width: 400px; flex-shrink: 0; border-right: 1px solid var(--border); background: #f1f5f9; display: flex; align-items: center; justify-content: center; }
            .feed-text-box { flex-grow: 1; padding: 30px; }
            .feed-img { width: 100%; height: 100%; object-fit: cover; min-height: 300px; cursor: pointer; }
        }
        /* Mobile Stack */
        @media (max-width: 899px) {
            .feed-flex { display: block; }
            .feed-img-box { width: 100%; border-bottom: 1px solid var(--border); height: auto; }
            .feed-img { width: 100%; display: block; cursor: pointer; }
            .feed-text-box { padding: 20px; }
        }

        /* Header Styles */
        .feed-h-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 15px; }
        .feed-title { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--primary); line-height: 1.2; }
        .feed-meta { font-size: 0.9rem; color: var(--secondary); font-weight: 600; }
        .feed-body-txt { font-size: 1rem; color: #334155; line-height: 1.7; white-space: pre-line; }

        /* Risk Boxes */
        .fc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-top: 25px; }
        .fc-box { background: #f8fafc; border: 1px solid var(--border); padding: 20px; border-radius: 10px; }
        .fc-box h4 { margin: 0 0 5px 0; font-size: 1rem; font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; }
        .risk-tag { padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        
        /* Specific Colors */
        .c-Slight { background: var(--risk-slight); color:black; } .b-Slight { border-left: 6px solid var(--risk-slight); }
        .c-Enhanced { background: var(--risk-enhanced); color:white; } .b-Enhanced { border-left: 6px solid var(--risk-enhanced); }
        .c-High { background: var(--risk-high); color:white; } .b-High { border-left: 6px solid var(--risk-high); }
        .c-Downpours { background: var(--risk-downpour); color:white; } .b-Downpours { border-left: 6px solid var(--risk-downpour); }
        .c-Critical { background: var(--risk-critical); color:white; } .b-Critical { border-left: 6px solid var(--risk-critical); }

        /* NEWS */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .news-card { text-decoration: none; color: inherit; background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column; transition: 0.2s; }
        .news-card:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: var(--shadow); }
        .nc-thumb { height: 180px; background-size: cover; background-position: center; background-color: #e2e8f0; border-bottom: 1px solid var(--border); }
        .nc-body { padding: 20px; flex-grow: 1; }
        .nc-title { font-weight: 700; margin-bottom: 5px; font-size: 1.1rem; line-height: 1.4; }
        .nc-date { font-size: 0.85rem; color: var(--secondary); }

        /* MODAL */
        .fc-modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .fc-modal { width: 95%; max-width: 700px; background: white; border-radius: 20px; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .fc-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .fc-body { padding: 0 20px 20px 20px; overflow-y: auto; }
        .fc-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .fc-icon { font-size: 1.5rem; width: 40px; text-align: center; margin-right: 15px; }

        /* ABOUT */
        .about-block { background: white; padding: 30px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .risk-def-box { padding: 20px; margin-bottom: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); font-size: 0.95rem; }
        
        /* --- ADMIN CSS --- */
        .adm-sidebar { width: 260px; background: white; padding: 20px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; z-index: 20; }
        .adm-content { flex-grow: 1; padding: 30px; overflow-y: auto; background: #f1f5f9; }
        
        .adm-nav-btn { display: block; width: 100%; text-align: left; padding: 14px; background: none; border: none; border-radius: 8px; color: var(--secondary); font-weight: 700; cursor: pointer; margin-bottom: 5px; transition: 0.2s; font-size: 0.9rem; }
        .adm-nav-btn:hover { background: #e2e8f0; color: var(--primary); }
        .adm-nav-btn.active { background: var(--adm-primary); color: white; box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.3); }
        
        .adm-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .adm-inp, .adm-sel, .adm-txt { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; font-family: inherit; background: #fff; transition: 0.2s; }
        .adm-inp:focus, .adm-sel:focus, .adm-txt:focus { outline: 2px solid var(--adm-primary); border-color: transparent; }
        
        .adm-act-btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .adm-act-btn:active { transform: translateY(1px); }
        .btn-p { background: var(--adm-primary); } .btn-p:hover { background: #1d4ed8; }
        .btn-s { background: #10b981; } .btn-s:hover { background: #059669; }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--primary); } .btn-sec:hover { background: #f8fafc; border-color: #cbd5e1; }
        
        .adm-list-item { background: #fff; border: 1px solid var(--border); padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .risk-chk-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .risk-chk-lbl { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--primary); cursor: pointer; }

        /* Archive Explorer */
        .arch-wrap { display: flex; border: 1px solid var(--border); background: white; border-radius: 8px; height: 500px; overflow: hidden; }
        .arch-tree { width: 250px; border-right: 1px solid var(--border); background: #f9fafb; overflow-y: auto; padding: 10px; }
        .arch-view { flex: 1; padding: 20px; overflow-y: auto; }
        .folder { cursor: pointer; padding: 6px; font-weight: 600; display: block; width: 100%; text-align: left; background: none; border: none; }
        .folder:hover { color: var(--adm-primary); }
        .file { cursor: pointer; padding: 6px 6px 6px 20px; display: flex; align-items: center; gap: 6px; color: var(--secondary); }
        .file:hover { background: #e2e8f0; color: var(--primary); border-radius: 4px; }

        #alert-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(to right, #ef4444, #b91c1c); color: white; text-align: center; padding: 12px; z-index: 2000; font-weight: 700; cursor: pointer; }
        body.has-alert header { top: 45px; }
        body.has-alert #public-app { padding-top: calc(var(--header-h) + 45px); }
        
        /* Login */
        .login-wrap { background: white; padding: 40px; border-radius: 16px; box-shadow: var(--shadow); width: 100%; max-width: 400px; }

        @media(max-width:900px) {
            #si-weather-root { flex-direction: column; height: auto; }
            .si-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
            #si-map { display: none; }
            .adm-sidebar { width: 100%; flex-direction: row; height: auto; overflow-x: auto; padding: 10px; border-bottom: 1px solid var(--border); border-right: none; }
            .arch-wrap { flex-direction: column; height: auto; }
            .arch-tree { width: 100%; height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body class="mode-public">

<!-- PUBLIC INTERFACE -->
<div id="public-app">
    <div id="alert-banner" onclick="window.location.hash='#/alerts'">‚ö†Ô∏è Weather Alerts Active - Click here</div>
    
    <header>
        <div class="nav-wrap">
            <div class="brand" onclick="window.location.hash='#/'"><img src="https://i.ibb.co/6P0n8xX/sima-logo-placeholder.png" alt="SIMA"></div>
            
            <nav class="d-menu">
                <a onclick="ui.go('#/')" class="nav-link">Home</a>
                <div class="dropdown-container">
                    <a onclick="ui.go('#/')" class="nav-link">Severe Weather <span style="font-size:0.7rem; margin-left:4px;">‚ñº</span></a>
                    <div class="dropdown-menu">
                        <a onclick="ui.go('#/outlook')" class="dropdown-link">Sig Weather Outlook</a>
                        <a onclick="ui.go('#/alerts')" class="dropdown-link">Alerts</a>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a onclick="ui.go('#/')" class="nav-link">Forecasts <span style="font-size:0.7rem; margin-left:4px;">‚ñº</span></a>
                    <div class="dropdown-menu">
                        <a onclick="ui.go('#/stormcast')" class="dropdown-link">StormCast</a>
                        <a onclick="ui.go('#/snowcast')" class="dropdown-link">SnowCast</a>
                        <a onclick="ui.go('#/drought')" class="dropdown-link">DroughtCast</a>
                    </div>
                </div>
                <a onclick="ui.go('#/news')" class="nav-link">News</a>
                <a onclick="ui.go('#/about')" class="nav-link">About Us</a>
            </nav>

            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="location.reload()" style="padding:8px 16px; border-radius:20px; background:white; border:1px solid var(--border); cursor:pointer; font-weight:600; color:var(--secondary);">Refresh</button>
                <button class="m-toggle" onclick="document.querySelector('.m-menu').classList.add('open')">‚ò∞</button>
            </div>
        </div>
    </header>

    <div class="m-menu">
        <div style="text-align:right"><button onclick="document.querySelector('.m-menu').classList.remove('open')" style="background:none;border:none;font-size:2rem;">&times;</button></div>
        <a onclick="ui.go('#/')" class="m-link">Home</a>
        <div class="m-header">Severe Weather</div>
        <a onclick="ui.go('#/outlook')" class="m-link">Outlook</a>
        <a onclick="ui.go('#/alerts')" class="m-link">Alerts</a>
        <div class="m-header">Forecasts</div>
        <a onclick="ui.go('#/stormcast')" class="m-link">StormCast</a>
        <a onclick="ui.go('#/snowcast')" class="m-link">SnowCast</a>
        <a onclick="ui.go('#/drought')" class="m-link">DroughtCast</a>
        <div class="m-header">Info</div>
        <a onclick="ui.go('#/news')" class="m-link">News</a>
        <a onclick="ui.go('#/about')" class="m-link">About Us</a>
    </div>

    <main class="container">
        
        <!-- HOME PAGE (RESTORED) -->
        <section id="page-home" class="page active">
            <div id="si-weather-root">
                <div class="si-sidebar">
                    <h2 style="font-weight:800; color:var(--primary); margin-bottom:10px;">SI Forecasts</h2>
                    <div style="position:relative;">
                        <input id="si-search" type="text" class="adm-inp" placeholder="Search town...">
                        <div id="si-res" class="si-results"></div>
                    </div>
                    
                    <div class="ext-tabs">
                        <button class="ext-tab active" onclick="siWidget.ext(0, this)">Current</button>
                        <button class="ext-tab" onclick="siWidget.ext(1, this)">Since Midnight</button>
                    </div>
                    
                    <div id="ext-container">
                        <div class="ext-row"><div class="ext-icon">üî•</div><div><span id="x-max" class="ext-val">--</span><span class="ext-label">Hottest <span id="l-max" class="ext-town"></span></span></div></div>
                        <div class="ext-row"><div class="ext-icon">‚ùÑÔ∏è</div><div><span id="x-min" class="ext-val">--</span><span class="ext-label">Coldest <span id="l-min" class="ext-town"></span></span></div></div>
                        <div class="ext-row"><div class="ext-icon">üí®</div><div><span id="x-wnd" class="ext-val">--</span><span class="ext-label">Gusts <span id="l-wnd" class="ext-town"></span></span></div></div>
                        <div class="ext-row"><div class="ext-icon">üåßÔ∏è</div><div><span id="x-rain" class="ext-val">--</span><span class="ext-label">Rain <span id="l-rain" class="ext-town"></span></span></div></div>
                    </div>
                </div>
                <div id="si-map"></div>
            </div>

            <!-- NEWS FEED HOME -->
            <div style="text-align:center; margin:50px 0 30px;">
                <h2 style="font-weight:800; font-size:1.8rem;">Latest Updates</h2>
            </div>
            <div id="home-news" class="news-grid"></div>

            <div style="text-align:center; margin-top:60px; padding-top:30px; border-top:1px solid #e2e8f0;">
                <button onclick="openLogin()" style="background:none; border:none; color:#94a3b8; cursor:pointer; text-decoration:underline;">Admin Panel Login</button>
            </div>
        </section>

        <!-- ALERTS -->
        <section id="page-alerts" class="page">
            <h1 style="text-align:center; color:var(--risk-high); font-weight:900; margin-bottom:40px; font-size:2.5rem;">Active Weather Alerts</h1>
            <div id="alert-meta" style="text-align:center; color:var(--secondary); max-width:700px; margin:0 auto 40px; font-size:1.1rem;"></div>
            <div id="alert-feed"></div>
        </section>

        <!-- OUTLOOK -->
        <section id="page-outlook" class="page">
            <div style="text-align:center; margin-bottom:40px;">
                <h1 style="font-weight:900; font-size:2.5rem;">Significant Weather Outlook</h1>
                <h2 id="swo-head" style="color:var(--primary); font-size:1.2rem; margin-top:5px;"></h2>
                <p id="swo-sub" style="color:var(--secondary); max-width:800px; margin:10px auto 0; font-size:1.1rem;"></p>
            </div>
            <div id="swo-feed"></div>
        </section>

        <!-- STORMCAST -->
        <section id="page-storm" class="page">
            <div style="text-align:center; margin-bottom:40px;">
                <h1 style="font-weight:900; font-size:2.5rem;">StormCast</h1>
                <p style="color:var(--secondary);">Severe Thunderstorm Convective Outlooks</p>
            </div>
            <div id="storm-feed"></div>
        </section>

        <!-- SNOWCAST -->
        <section id="page-snow" class="page">
            <div style="text-align:center; margin-bottom:40px;">
                <h1 style="font-weight:900; font-size:2.5rem; color:#1e3a8a;">SnowCast</h1>
                <p id="snow-intro" style="color:var(--secondary); font-size:1.1rem;"></p>
            </div>
            <div id="snow-feed"></div>
        </section>

        <!-- DROUGHT -->
        <section id="page-drought" class="page">
            <div style="text-align:center; margin-bottom:40px;">
                <h1 style="font-weight:900; font-size:2.5rem; color:#d97706;">DroughtCast</h1>
                <p id="drought-intro" style="color:var(--secondary); font-size:1.1rem;"></p>
            </div>
            <div id="drought-feed"></div>
        </section>

        <!-- NEWS -->
        <section id="page-news" class="page">
            <h1 style="text-align:center; font-weight:900; margin-bottom:40px;">Weather News</h1>
            <div id="news-full" class="news-grid"></div>
        </section>

        <!-- ARTICLE -->
        <section id="page-article" class="page">
            <button onclick="window.history.back()" style="border:none; background:none; color:var(--secondary); font-weight:700; cursor:pointer; margin-bottom:20px;">&larr; Back</button>
            <div class="feed-item-card" style="padding:40px;" id="article-viewer">Loading...</div>
        </section>

        <!-- ABOUT -->
        <section id="page-about" class="page">
            <div class="about-block">
                <h2 style="font-weight:800; margin-bottom:20px;">About Us</h2>
                <p style="margin-bottom:15px;">SIMA (South Island Meteorological Agency) is an independent forecast provider dedicated to the South Island of New Zealand. We are not a government agency.</p>
                <p>Severe Weather New Zealand started out in 2006 as a blog site writing weather updates on high risk severe weather events before establishing ourselves on Facebook in 2011 and now have a following of ~35,000 people. This page is currently run by Lewis Ferris who lives in Christchurch.</p>
            </div>

            <div class="about-block">
                <h3 style="margin-bottom:20px;">Severe Weather Criteria</h3>
                <p><strong>Thunderstorm Risks</strong></p>
                
                <div class="risk-def-box bg-Slight" style="background:#fefce8; color:#422006; border-left:5px solid var(--risk-slight);">
                    <strong>Slight Risk (Yellow)</strong><br>
                    Probability: Less than 30% (but not zero) chance of impactful severe weather within the highlighted area.<br>
                    Description: While the probability is low, weather-related impacts are still possible and warrant monitoring.
                </div>
                <div class="risk-def-box bg-Enhanced" style="background:#fff7ed; color:#7c2d12; border-left:5px solid var(--risk-enhanced);">
                    <strong>Enhanced Risk (Orange)</strong><br>
                    Probability: 30‚Äì50% chance of impactful severe weather.<br>
                    Description: Conditions suggest an increased likelihood of weather-related impacts. Preparedness is advised.
                </div>
                <div class="risk-def-box bg-High" style="background:#fef2f2; color:#7f1d1d; border-left:5px solid var(--risk-high);">
                    <strong>High Risk (Red)</strong><br>
                    Probability: 50‚Äì70% chance of impactful severe weather.<br>
                    Description: A high risk indicates a strong potential for significant weather impacts. Special Weather Statements will likely be issued.
                </div>
                <div class="risk-def-box bg-Critical" style="background:#faf5ff; color:#581c87; border-left:5px solid var(--risk-critical);">
                    <strong>Critical Risk (Purple)</strong><br>
                    Probability: At least 70% confidence in occurrence.<br>
                    Description: Reserved for the most severe weather events where there is a significant risk to life or property.
                </div>
            </div>

            <div class="terms-dropdown" style="border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; margin-top:30px;">
                <div style="padding:15px; background:#f8fafc; font-weight:700; cursor:pointer; display:flex; justify-content:space-between;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'">Terms & Conditions (2025) <span>&#9662;</span></div>
                <div style="display:none; padding:30px; background:white; font-size:0.9rem; color:#334155; white-space:pre-line;">
                    <strong>South Island Met Agency (SIMA) ‚Äî Website Terms & Conditions<br>Effective date: 18 September 2025</strong>

                    Welcome to the website of South Island Met Agency, trading as SIMA ("we", "us", or "our")... [Content as requested] ...
                    
                    1. License to Use the Site
                    Subject to these Terms, we grant you a limited, non-exclusive...
                    
                    5. Limited Risk-Level Notices Only
                    SIMA issues risk level assessments for informational purposes only and are not official warnings...
                    
                    18. Contact
                    Contact: southislandmet@gmail.com
                    
                    ¬© 2025 South Island Met Agency (SIMA). All rights reserved.
                </div>
            </div>
        </section>

    </main>
</div>

<!-- ADMIN PANEL -->
<div id="admin-app">
    <div id="sima-admin-wrapper">
        <div class="adm-sidebar">
            <div class="adm-brand">SIMA Admin</div>
            <button class="adm-nav-btn active" onclick="ui.admTab('alerts')">Alerts</button>
            <button class="adm-nav-btn" onclick="ui.admTab('swo')">Outlook</button>
            <button class="adm-nav-btn" onclick="ui.admTab('storm')">StormCast</button>
            <button class="adm-nav-btn" onclick="ui.admTab('snow')">SnowCast</button>
            <button class="adm-nav-btn" onclick="ui.admTab('drought')">DroughtCast</button>
            <button class="adm-nav-btn" onclick="ui.admTab('arch')">Archive</button>
            <button class="adm-nav-btn" style="margin-top:30px; color:#ef4444;" onclick="auth.logout()">Logout</button>
        </div>
        <div class="adm-content">
            
            <!-- ADMIN: ALERTS -->
            <div id="adm-alerts" class="adm-pane">
                <h1 style="margin-bottom:20px;">Weather Alerts</h1>
                <div class="adm-card">
                    <textarea id="ag-over" class="adm-txt" rows="2" placeholder="Global Alert Overview text..."></textarea>
                    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                    <h3>Add Warning</h3>
                    <div class="grid-2">
                        <div><select id="ag-type" class="adm-sel"><option>Watch</option><option>Warning</option><option>Special Statement</option></select></div>
                        <div><select id="ag-haz" class="adm-sel"><option>Heavy Rain</option><option>Severe Thunderstorms</option><option>Strong Wind</option><option>Snow</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div><input id="ag-reg" class="adm-inp" placeholder="Areas (comma sep)"></div>
                        <div><input type="datetime-local" id="ag-end" class="adm-inp"></div>
                    </div>
                    <label>Start Time</label><input type="datetime-local" id="ag-start" class="adm-inp">
                    <textarea id="ag-det" class="adm-txt" rows="3" placeholder="Alert text body..."></textarea>
                    <button onclick="adm.stage('alerts')" class="adm-act-btn btn-sec" style="width:100%">+ Add to Active List</button>
                </div>
                <h3 style="margin:20px 0 10px;">Active Alerts (Server)</h3>
                <div id="list-alerts"></div>
                <button onclick="adm.publish('alerts')" class="adm-act-btn btn-p" style="width:100%; margin-top:20px;">Publish All Alerts</button>
            </div>

            <!-- ADMIN: OUTLOOK (SWO) -->
            <div id="adm-swo" class="adm-pane" style="display:none;">
                <h1 style="margin-bottom:20px;">Sig. Weather Outlook</h1>
                <div class="adm-card">
                    <input id="swo-title" class="adm-inp" placeholder="Outlook Main Title">
                    <textarea id="swo-main" class="adm-txt" rows="2" placeholder="Overall Summary"></textarea>
                </div>
                <div class="adm-card">
                    <h3>Add Day Forecast</h3>
                    <div class="grid-2">
                        <div><input type="date" id="swo-d-date" class="adm-inp"></div>
                        <div><select id="swo-d-risk" class="adm-sel"><option>Low</option><option>Moderate</option><option>High</option></select></div>
                    </div>
                    <input type="file" id="swo-d-img" class="adm-inp">
                    <textarea id="swo-d-sum" class="adm-txt" rows="3" placeholder="Forecast synopsis..."></textarea>
                    <button onclick="adm.stageSwo()" class="adm-act-btn btn-s" style="width:100%">+ Add Forecast Day</button>
                </div>
                <div id="list-swo"></div>
                <button onclick="adm.publish('swo')" class="adm-act-btn btn-p" style="width:100%; margin-top:20px;">Publish Outlook</button>
            </div>

            <!-- ADMIN: STORMCAST -->
            <div id="adm-storm" class="adm-pane" style="display:none;">
                <h1 style="margin-bottom:20px;">StormCast</h1>
                <div class="adm-card">
                    <input id="st-title" class="adm-inp" placeholder="Main Title">
                    <div class="grid-2">
                        <div><label>Date</label><input type="date" id="st-date" class="adm-inp"></div>
                        <div><label>Upload Map</label><input type="file" id="st-img" class="adm-inp"></div>
                    </div>
                    <textarea id="st-dsc" class="adm-txt" rows="4" placeholder="Overall Convective Discussion..."></textarea>
                    
                    <div style="background:#f9fafb; padding:20px; border:1px solid #eee; border-radius:8px; margin-top:20px;">
                        <h4>Add Region Detail</h4>
                        <div class="grid-2">
                            <div><input id="st-r-name" class="adm-inp" placeholder="Region Name"></div>
                            <div><select id="st-r-risk" class="adm-sel"><option>Slight</option><option>Enhanced</option><option>High</option><option>Downpours</option></select></div>
                        </div>
                        <input id="st-r-time" class="adm-inp" placeholder="Timeframe (e.g. 3pm - 9pm)">
                        <div class="risk-chk-grid">
                            <label class="risk-chk-lbl"><input type="checkbox" class="rc" value="Heavy Rain"> Rain</label>
                            <label class="risk-chk-lbl"><input type="checkbox" class="rc" value="Large Hail"> Hail</label>
                            <label class="risk-chk-lbl"><input type="checkbox" class="rc" value="Wind Gusts"> Wind</label>
                            <label class="risk-chk-lbl"><input type="checkbox" class="rc" value="Tornadoes"> Tornadoes</label>
                        </div>
                        <textarea id="st-r-det" class="adm-txt" rows="2" placeholder="Regional details..."></textarea>
                        <button onclick="adm.stageStormRegion()" class="adm-act-btn btn-sec" style="width:100%">+ Add Region</button>
                    </div>
                    <div id="st-r-list" style="padding:10px; color:var(--secondary);"></div>
                </div>
                <div id="list-storm"></div>
                <button onclick="adm.publish('storm')" class="adm-act-btn btn-p" style="width:100%">Publish StormCast</button>
            </div>

            <!-- ADMIN: SNOW -->
            <div id="adm-snow" class="adm-pane" style="display:none;">
                <h1 style="margin-bottom:20px;">SnowCast</h1>
                <div class="adm-card">
                    <input id="sn-title" class="adm-inp" placeholder="Headline">
                    <textarea id="sn-over" class="adm-txt" rows="2" placeholder="Overview"></textarea>
                    <hr style="margin:20px 0;">
                    <h3>Add Snow Area</h3>
                    <div class="grid-2">
                        <div><input id="sn-reg" class="adm-inp" placeholder="Area"></div>
                        <div><select id="sn-lvl" class="adm-sel"><option>Watch</option><option>Warning</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Valid From</label><input type="datetime-local" id="sn-start" class="adm-inp"></div>
                        <div><label>Valid To</label><input type="datetime-local" id="sn-end" class="adm-inp"></div>
                    </div>
                    <textarea id="sn-det" class="adm-txt" placeholder="Accumulation details..."></textarea>
                    <button onclick="adm.stage('snow')" class="adm-act-btn btn-sec" style="width:100%">+ Add Area</button>
                </div>
                <div id="list-snow"></div>
                <button onclick="adm.publish('snow')" class="adm-act-btn btn-p" style="width:100%">Publish SnowCast</button>
            </div>

            <!-- ADMIN: DROUGHT -->
            <div id="adm-drought" class="adm-pane" style="display:none;">
                <h1 style="margin-bottom:20px;">DroughtCast</h1>
                <div class="adm-card">
                    <input id="dc-title" class="adm-inp" placeholder="Main Title">
                    <textarea id="dc-sum" class="adm-txt" placeholder="Summary..."></textarea>
                    <hr style="margin:20px 0;">
                    <h3>Add Area</h3>
                    <div class="grid-2">
                        <div><input id="dc-reg" class="adm-inp" placeholder="Region"></div>
                        <div><select id="dc-sev" class="adm-sel"><option>Dry</option><option>Very Dry</option><option>Extreme</option></select></div>
                    </div>
                    <div class="grid-2">
                        <div><input type="date" id="dc-end" class="adm-inp"></div>
                        <div><input id="dc-rain" class="adm-inp" placeholder="Rain Potential"></div>
                    </div>
                    <button onclick="adm.stage('drought')" class="adm-act-btn btn-sec" style="width:100%">+ Add Area</button>
                </div>
                <div id="list-drought"></div>
                <button onclick="adm.publish('drought')" class="adm-act-btn btn-p" style="width:100%">Publish</button>
            </div>

            <!-- ADMIN: ARCHIVE -->
            <div id="adm-arch" class="adm-pane" style="display:none;">
                <h1>Archive Explorer</h1>
                <div class="arch-wrap">
                    <div id="arc-tree" class="arch-tree"></div>
                    <div id="arc-view" class="arch-view">Select a date to view historical maps/forecasts.</div>
                </div>
                <button onclick="adm.loadArch()" class="adm-act-btn btn-sec" style="width:100%; margin-top:20px;">Force Refresh</button>
            </div>

        </div>
    </div>
</div>

<!-- GLOBAL MODALS -->
<div class="fc-modal-overlay" id="fc-modal">
    <div class="fc-modal">
        <div class="fc-head"><span id="fc-title" style="font-weight:700;">Title</span><button onclick="document.getElementById('fc-modal').style.display='none'" style="background:none;border:none;font-size:1.5rem;">&times;</button></div>
        <div id="fc-body" class="fc-body"></div>
    </div>
</div>

<!-- LOGIN -->
<div id="login-screen" class="mode-login">
    <div class="login-wrap">
        <h2 style="text-align:center;margin-bottom:20px;">SIMA Login</h2>
        <input id="em" class="adm-inp" type="email" placeholder="Email">
        <input id="pw" class="adm-inp" type="password" placeholder="Password">
        <button onclick="auth.login()" class="adm-act-btn btn-p" style="width:100%">Sign In</button>
        <button onclick="closeLogin()" style="width:100%;background:none;border:none;color:gray;margin-top:10px;cursor:pointer;">Cancel</button>
    </div>
</div>

<!-- MODAL IMAGE (Archive) -->
<div class="fc-modal-overlay" id="img-modal">
    <div style="max-width:800px;width:100%;max-height:90vh;background:white;border-radius:12px;overflow:auto;position:relative;">
        <button onclick="document.getElementById('img-modal').style.display='none'" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;">X</button>
        <img id="fs-img" style="width:100%;display:block;">
    </div>
</div>

<div id="toast" style="position:fixed;bottom:30px;right:30px;background:#1f2937;color:white;padding:12px 20px;border-radius:30px;display:none;z-index:9999;">Done</div>

<script>
// --- CORE CONFIG ---
const API = {
    key: '$2a$10$/h3xvps5BAmoU8dJigw8T.qYg3eoESVLwjXbX9aHmb85Y96cExsCe',
    img: '11bca15e224ed683c68e78cc0013c205',
    url: (b) => `https://api.jsonbin.io/v3/b/${{alerts:'68db095dae596e708f0072be',storm:'68d8cdac43b1c97be9528f9b',snow:'68e0738e43b1c97be9599eb1',sig:'68d8c3c6d0ea881f408d7a5c',drought:'68d9fc07d0ea881f408e8e5b'}[b]}?t=${Date.now()}`
};

const state = {
    alerts:{active:[],arch:[]}, swo:{active:[],arch:[]}, storm:{active:[],arch:[]}, snow:{active:[],arch:[]}, drought:{active:[]},
    temp:{regs:[]},
    news: []
};

// --- AUTH ---
const auth = {
    login: () => {
        const e=document.getElementById('em').value, p=document.getElementById('pw').value;
        if(((e==='mattfrancke22@gmail.com'||e==='jacobmcpartlinnz@gmail.com') && p==='password')) {
            document.body.className='mode-admin'; adm.init();
        } else alert('Invalid credentials');
    },
    logout: () => { document.body.className='mode-public'; }
};
const openLogin=()=>document.body.className='mode-login';
const closeLogin=()=>document.body.className='mode-public';

// --- PUBLIC LOGIC ---
const ui = {
    init: () => {
        const h = window.location.hash || '#/';
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        let id = 'page-home';
        
        if(h.includes('article')) { id='page-article'; pub.readArticle(h.split('/')[2]); }
        else if(h.includes('alerts')) { id='page-alerts'; pub.load('alerts'); }
        else if(h.includes('storm')) { id='page-storm'; pub.load('storm'); }
        else if(h.includes('snow')) { id='page-snow'; pub.load('snow'); }
        else if(h.includes('outlook')) { id='page-outlook'; pub.load('swo'); }
        else if(h.includes('drought')) { id='page-drought'; pub.load('drought'); }
        else if(h.includes('news')) { id='page-news'; pub.loadNews(); }
        else if(h.includes('about')) { id='page-about'; }
        
        document.getElementById(id).classList.add('active');
        document.querySelector('.m-menu').classList.remove('open');
        if(id==='page-home'){ mapWidget.init(); pub.loadNews(true); }
        window.addEventListener('hashchange', ui.init);
    },
    go: (h) => window.location.hash = h,
    admTab: (t) => {
        document.querySelectorAll('.adm-pane').forEach(e=>e.style.display='none');
        document.getElementById('adm-'+t).style.display='block';
        document.querySelectorAll('.adm-nav-btn').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        if(t==='arch') adm.loadArch();
    }
};

const pub = {
    req: async (k) => { try { return await (await fetch(API.url(k), {headers:{'X-Master-Key':API.key}})).json(); } catch(e){ return {record:{}}; } },
    load: async (k) => {
        const d = await pub.req(k);
        const today = new Date().toLocaleDateString('en-CA', {timeZone:'Pacific/Auckland'});
        
        if(k==='alerts') {
            const active = (d.record.blocks||[]).filter(b => new Date(b.endTime) > new Date());
            document.getElementById('alert-meta').innerText = d.record.globalInfo?.overview || 'No current advisories.';
            const html = active.map(b => `<div class="feed-item-card border-${b.type.split(' ')[0]||'Slight'}"><div class="feed-head"><strong>${b.weatherType}</strong><span class="badge c-${b.type.split(' ')[0]}">${b.type}</span></div><div class="feed-body"><p style="font-weight:700;margin-bottom:10px;">Area: ${b.regions}</p><p>${b.summary}</p><small style="color:#94a3b8;display:block;margin-top:10px;">Until ${new Date(b.endTime).toLocaleString()}</small></div></div>`).join('');
            document.getElementById('alert-feed').innerHTML = html || '<div style="text-align:center;padding:40px;color:#aaa;">No Active Warnings</div>';
            document.getElementById('alert-banner').style.display = active.length ? 'block' : 'none';
            document.body.classList.toggle('has-alert', active.length > 0);
        }
        if(k==='storm') {
            const active = (d.record.outlooks||[]).filter(o => o.validDate >= today || new Date(o.validUntil) > new Date());
            document.getElementById('storm-feed').innerHTML = active.map(o => `
            <div class="feed-item-card">
                <div class="feed-content-wrapper">
                    ${o.mapUrl ? `<div class="feed-img-wrapper"><img src="${o.mapUrl}" class="feed-img" onclick="viewImg('${o.mapUrl}')"></div>` : ''}
                    <div class="feed-text-wrapper">
                        <h2 style="margin-bottom:10px;">${o.title}</h2>
                        <div style="color:var(--secondary); margin-bottom:15px; font-weight:600;">Valid: ${o.validDate||''}</div>
                        <p class="feed-body-txt">${o.overallDiscussion}</p>
                        <div class="fc-grid">
                            ${(o.regionalForecasts||[]).map(r=>`<div class="fc-region-box b-${r.riskLevel}">
                                <div style="display:flex;justify-content:space-between;"><strong>${r.regionName}</strong><span class="risk-tag c-${r.riskLevel}">${r.riskLevel}</span></div>
                                <small style="color:var(--secondary); display:block; margin:5px 0;">${r.timeframe||''}</small>
                                <div style="margin:5px 0;">${(r.risks||[]).map(t=>`<span style="font-size:0.7rem;padding:2px 6px;background:#e2e8f0;margin-right:4px;border-radius:4px;">${t}</span>`).join('')}</div>
                                <p style="font-size:0.9rem; margin-top:5px;">${r.threats}</p>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`).join('');
        }
        if(k==='swo') {
            const active = (d.record.forecasts||[]).filter(f => f.date >= today).sort((a,b)=>new Date(a.date)-new Date(b.date));
            document.getElementById('swo-head').innerText = d.record.overallTitle||'';
            document.getElementById('swo-sub').innerText = d.record.overallSummary||'';
            document.getElementById('swo-feed').innerHTML = active.map(f => `<div class="feed-item-card"><div class="feed-content-wrapper">${f.imageUrl?`<div class="feed-img-wrapper"><img src="${f.imageUrl}" class="feed-img" onclick="viewImg('${f.imageUrl}')"></div>`:''}<div class="feed-text-wrapper"><h3>${new Date(f.date).toDateString()}</h3><span class="risk-tag c-${f.alertLevel}" style="margin:10px 0; display:inline-block;">${f.alertLevel}</span><p class="feed-body-txt">${f.summary}</p></div></div></div>`).join('');
        }
        if(k==='snow') {
            const active = (d.record.forecasts||[]).filter(x => new Date(x.validTo) > new Date());
            document.getElementById('snow-intro').innerText = d.record.overview||'';
            document.getElementById('snow-feed').innerHTML = active.map(f => `<div class="feed-item-card b-${f.riskLevel}"><div class="feed-head"><strong>${f.region}</strong><span class="risk-tag c-${f.riskLevel}">${f.riskLevel}</span></div><div class="feed-body"><p>${f.summary}</p><small>Expires: ${new Date(f.validTo).toLocaleString()}</small></div></div>`).join('');
        }
        if(k==='drought') {
            document.getElementById('drought-intro').innerText = d.record.overview?.summary||'';
            document.getElementById('drought-feed').innerHTML = (d.record.alerts||[]).map(a => `<div class="feed-item-card"><div class="feed-head"><strong>${a.region}</strong><span class="risk-tag" style="background:#ea580c;color:white;">${a.severity}</span></div><div class="feed-body"><p>${a.summary}</p><p><strong>Rain Potential:</strong> ${a.rainPotential}</p></div></div>`).join('');
        }
    },
    loadNews: async (home) => {
        try {
            const r = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://southislandmet.blogspot.com/feeds/posts/default');
            const j = await r.json(); state.news = j.items;
            const render = (i) => {
                const div = document.createElement('div'); div.innerHTML = i.description;
                const img = div.querySelector('img')?.src || 'https://via.placeholder.com/400x200?text=Weather+News';
                const slug = i.title.replace(/[^a-z0-9]/gi,'-').toLowerCase();
                return `<a onclick="ui.go('#/article/${slug}')" class="news-card"><div class="nc-thumb" style="background-image:url('${img}')"></div><div class="nc-body"><div class="nc-title">${i.title}</div><div class="nc-date">${new Date(i.pubDate).toDateString()}</div></div></a>`;
            }
            const list = home ? j.items.slice(0,3) : j.items;
            document.getElementById(home?'home-news':'news-full').innerHTML = list.map(render).join('');
        } catch(e){}
    },
    readArticle: (slug) => {
        const item = state.news.find(x => x.title.replace(/[^a-z0-9]/gi,'-').toLowerCase() === slug);
        const v = document.getElementById('article-viewer');
        if(item) v.innerHTML = `<h1 style="margin-bottom:10px;">${item.title}</h1><div style="color:var(--secondary);margin-bottom:20px;">${new Date(item.pubDate).toLocaleString()}</div><div style="line-height:1.8; font-size:1.1rem;">${item.description}</div>`;
        else {
            v.innerHTML = 'Loading article... (If it fails, check news page)';
            pub.loadNews(false).then(()=>pub.readArticle(slug)); // retry
        }
    }
};

function viewImg(url) { document.getElementById('fs-img').src=url; document.getElementById('img-modal').style.display='flex'; }

// --- HOME MAP WIDGET ---
const mapWidget = (function(){
    const towns = [{name:"Nelson",lat:-41.27,lng:173.28},{name:"Blenheim",lat:-41.51,lng:173.96},{name:"Westport",lat:-41.75,lng:171.60},{name:"Kaikoura",lat:-42.40,lng:173.68},{name:"Christchurch",lat:-43.53,lng:172.63},{name:"Timaru",lat:-44.39,lng:171.25},{name:"Queenstown",lat:-45.03,lng:168.66},{name:"Wanaka",lat:-44.70,lng:169.15},{name:"Dunedin",lat:-45.87,lng:170.50},{name:"Invercargill",lat:-46.41,lng:168.35},{name:"Mt Cook",lat:-43.73,lng:170.10},{name:"Greymouth",lat:-42.45,lng:171.20}];
    let map;
    
    function init() {
        if(!map) {
            map = L.map('si-map',{zoomControl:false}).setView([-43.8, 170.5], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            towns.forEach(t => {
                L.circleMarker([t.lat, t.lng], {color:'#0ea5e9', fillColor:'#0ea5e9', fillOpacity:0.8, radius:6}).addTo(map).on('click', () => getFc(t));
            });
        }
        
        // Town search
        document.getElementById('si-search').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const list = document.getElementById('si-res');
            if(val.length < 2) { list.style.display='none'; return; }
            const match = towns.filter(x => x.name.toLowerCase().includes(val));
            list.innerHTML = match.map(x => `<div class="si-res-item" onclick="mapWidget.load('${x.name}')">${x.name}</div>`).join('');
            list.style.display = match.length ? 'block' : 'none';
        });
        
        calcExtremes(false);
    }
    
    function load(n) {
        const t = towns.find(x=>x.name===n);
        if(t) getFc(t);
        document.getElementById('si-res').style.display='none';
    }

    async function getFc(t) {
        try {
            const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${t.lat}&longitude=${t.lng}&current=temperature_2m,wind_speed_10m,relative_humidity_2m&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max&timezone=Pacific%2FAuckland`);
            const d = await r.json();
            const h = d.daily.time.slice(0,5).map((day, i) => `
                <div class="fc-row">
                    <div style="width:50px;font-weight:700;">${new Date(day).toLocaleDateString('en-NZ',{weekday:'short'})}</div>
                    <div style="flex:1;text-align:center;">H:${Math.round(d.daily.temperature_2m_max[i])}¬∞ L:${Math.round(d.daily.temperature_2m_min[i])}¬∞</div>
                    <div class="fc-icon" style="font-size:1rem;width:60px;">üíß ${d.daily.precipitation_sum[i]}mm</div>
                    <div class="fc-icon" style="font-size:1rem;width:60px;">üí® ${Math.round(d.daily.wind_speed_10m_max[i])}</div>
                </div>
            `).join('');
            
            const now = `<div style="text-align:center;padding:15px;border-bottom:1px solid #eee;">
                <div style="font-size:3rem;font-weight:800;line-height:1;color:var(--primary);">${Math.round(d.current.temperature_2m)}¬∞</div>
                <div style="color:var(--secondary);margin-top:5px;">Wind: ${d.current.wind_speed_10m}kph ‚Ä¢ Hum: ${d.current.relative_humidity_2m}%</div>
            </div>`;
            
            document.getElementById('fm-title').innerText = t.name;
            document.getElementById('fc-body').innerHTML = now + h;
            document.getElementById('fc-modal').style.display = 'flex';
        } catch(e){}
    }

    async function calcExtremes(daily) {
        // Pseudo implementation to fetch stats for all towns
        // In prod, maybe optimized via single API call or 15 separate
        let max=-99, min=99, w=0, r=0;
        let lmax='', lmin='', lw='', lr='';
        
        // For stability, we will loop but limit calls
        for(let t of towns.slice(0,6)) { // just check 6 for speed demo
            try {
                const p = daily ? '&daily=temperature_2m_max,temperature_2m_min,wind_gusts_10m_max,precipitation_sum' : '&current=temperature_2m,rain,wind_gusts_10m';
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${t.lat}&longitude=${t.lng}${p}&timezone=Pacific%2FAuckland`);
                const j = await res.json();
                
                if(daily) {
                    if(j.daily.temperature_2m_max[0] > max) { max=j.daily.temperature_2m_max[0]; lmax=t.name; }
                    if(j.daily.temperature_2m_min[0] < min) { min=j.daily.temperature_2m_min[0]; lmin=t.name; }
                    if(j.daily.wind_gusts_10m_max[0] > w) { w=j.daily.wind_gusts_10m_max[0]; lw=t.name; }
                    if(j.daily.precipitation_sum[0] > r) { r=j.daily.precipitation_sum[0]; lr=t.name; }
                } else {
                    if(j.current.temperature_2m > max) { max=j.current.temperature_2m; lmax=t.name; }
                    if(j.current.temperature_2m < min) { min=j.current.temperature_2m; lmin=t.name; }
                    if(j.current.wind_gusts_10m > w) { w=j.current.wind_gusts_10m; lw=t.name; }
                    if(j.current.rain > r) { r=j.current.rain; lr=t.name; }
                }
            } catch(e){}
        }
        // Default vals if fails
        document.getElementById('x-max').innerText = max>-99 ? max+"¬∞" : "--"; document.getElementById('l-max').innerText=lmax;
        document.getElementById('x-min').innerText = min<99 ? min+"¬∞" : "--"; document.getElementById('l-min').innerText=lmin;
        document.getElementById('x-wnd').innerText = w+"kph"; document.getElementById('l-wnd').innerText=lw;
        document.getElementById('x-rain').innerText = r+"mm"; document.getElementById('l-rain').innerText=lr;
    }

    return { init, load, ext: (m, b) => {
        document.querySelectorAll('.ext-tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
        calcExtremes(m===1);
    }};
})();

// --- ADMIN SYSTEM ---
const adm = {
    up: async (el) => {
        if(!el.files[0]) return null; const fd=new FormData(); fd.append('image',el.files[0]);
        try { return (await (await fetch(`https://api.imgbb.com/1/upload?key=${API.img}`,{method:'POST',body:fd})).json()).data.url; }
        catch(e){ return null; }
    },
    
    init: async () => {
        // Fetch Everything
        const [al, st, sn, si, dr] = await Promise.all(['alerts','storm','snow','sig','drought'].map(pub.req));
        
        // Setup State (Preserve inputs)
        state.alerts.active = al.record.blocks||[]; state.alerts.arch = al.record.archive||[];
        state.swo.active = si.record.forecasts||[]; state.swo.arch = si.record.archive||[];
        state.storm.active = st.record.outlooks||[]; state.storm.arch = st.record.archive||[];
        state.snow.active = sn.record.forecasts||[]; state.snow.arch = sn.record.archive||[];
        state.drought.active = dr.record.alerts||[];

        // Check Archives & Render
        const check = (list, dateKey, isStr) => {
            const keep=[], arch=[];
            const now = new Date().toLocaleDateString('en-CA',{timeZone:'Pacific/Auckland'}); // NZ YYYY-MM-DD
            list.forEach(i => {
                if(isStr) { i[dateKey] >= now ? keep.push(i) : arch.push(i); } 
                else { new Date(i[dateKey]) > new Date() ? keep.push(i) : arch.push(i); }
            });
            return {keep, arch};
        }

        const swoChk = check(state.swo.active, 'date', true);
        if(swoChk.arch.length) { state.swo.active=swoChk.keep; state.swo.arch.push(...swoChk.arch); adm.pub('swo',true); }
        
        const stChk = check(state.storm.active, 'validDate', true);
        // Storm Logic Exception: If validUntil > now, also keep
        const stormKeep=[], stormArch=[];
        state.storm.active.forEach(o => {
            if(o.validDate >= new Date().toLocaleDateString('en-CA',{timeZone:'Pacific/Auckland'}) || new Date(o.validUntil) > new Date()) stormKeep.push(o); else stormArch.push(o);
        });
        if(stormArch.length) { state.storm.active=stormKeep; state.storm.arch.push(...stormArch); adm.pub('storm',true); }

        // Pre-fill global text areas
        if(al.record.globalInfo) document.getElementById('ag-over').value = al.record.globalInfo.overview || '';
        if(si.record.overallTitle) document.getElementById('swo-title').value = si.record.overallTitle;
        if(si.record.overallSummary) document.getElementById('swo-main').value = si.record.overallSummary;
        if(sn.record.mainTitle) document.getElementById('sn-title').value = sn.record.mainTitle;
        if(sn.record.overview) document.getElementById('sn-main').value = sn.record.overview;
        if(dr.record.overview) { document.getElementById('dc-title').value=dr.record.overview.title; document.getElementById('dc-sum').value=dr.record.overview.summary; }

        // Render Lists
        adm.renAll();
    },

    stage: (t) => {
        if(t==='alerts'){
            state.alerts.active.push({
                type: document.getElementById('ag-type').value,
                weatherType: document.getElementById('ag-haz').value,
                regions: document.getElementById('ag-reg').value,
                startTime: document.getElementById('ag-start').value,
                endTime: document.getElementById('ag-end').value,
                summary: document.getElementById('ag-det').value
            });
        }
        if(t==='snow') state.snow.active.push({region:document.getElementById('sn-reg').value, riskLevel:document.getElementById('sn-lvl').value, validFrom:document.getElementById('sn-start').value, validTo:document.getElementById('sn-end').value, summary:document.getElementById('sn-det').value});
        if(t==='drought') state.drought.active.push({region:document.getElementById('dc-reg').value, severity:document.getElementById('dc-sev').value, rainPotential:document.getElementById('dc-rain').value, endDate:document.getElementById('dc-end').value});
        
        adm.renAll();
    },

    stageSwo: async () => {
        const img = await adm.up(document.getElementById('swo-d-img'));
        state.swo.active.push({date:document.getElementById('swo-d-date').value, alertLevel:document.getElementById('swo-d-risk').value, summary:document.getElementById('swo-d-sum').value, imageUrl:img});
        state.swo.active.sort((a,b)=>new Date(a.date)-new Date(b.date));
        adm.renAll();
    },

    stageStormRegion: () => {
        const r = Array.from(document.querySelectorAll('.rc:checked')).map(c=>c.value);
        state.temp.regs.push({
            regionName: document.getElementById('st-r-name').value,
            riskLevel: document.getElementById('st-r-risk').value,
            timeframe: document.getElementById('st-r-time').value,
            threats: document.getElementById('st-r-det').value,
            risks: r
        });
        document.getElementById('st-r-list').innerText = state.temp.regs.map(x=>x.regionName).join(', ');
    },

    pub: async (t, silent=false) => {
        // Prep Payloads
        let p = {};
        if(t==='alerts') p = {globalInfo:{overview:document.getElementById('ag-over').value}, blocks:state.alerts.active, archive:state.alerts.arch};
        if(t==='swo') p = {overallTitle:document.getElementById('swo-title').value, overallSummary:document.getElementById('swo-main').value, forecasts:state.swo.active, archive:state.swo.arch};
        if(t==='snow') p = {mainTitle:document.getElementById('sn-title').value, overview:document.getElementById('sn-main').value, forecasts:state.snow.active, archive:state.snow.arch};
        if(t==='drought') p = {overview:{title:document.getElementById('dc-title').value, summary:document.getElementById('dc-sum').value}, alerts:state.drought.active};
        if(t==='storm') {
            // Add parent Outlook object only if main fields are present
            if(document.getElementById('st-title').value) {
                const img = await adm.up(document.getElementById('st-img'));
                state.storm.active.push({
                    title: document.getElementById('st-title').value,
                    validDate: document.getElementById('st-date').value,
                    overallDiscussion: document.getElementById('st-dsc').value,
                    mapUrl: img,
                    regionalForecasts: state.temp.regs
                });
                state.temp.regs = []; document.getElementById('st-r-list').innerText=''; // clear
            }
            p = {outlooks:state.storm.active, archive:state.storm.arch};
        }

        await fetch(API.url(t).split('?')[0], { method:'PUT', headers:{'Content-Type':'application/json', 'X-Master-Key':API.key}, body:JSON.stringify(p)});
        if(!silent) {
            document.getElementById('toast').style.display='block';
            setTimeout(()=>document.getElementById('toast').style.display='none', 3000);
            adm.init(); // Reload to reflect server
        }
    },

    renAll: () => {
        // Renders all Active Lists
        const ren = (el, list, lbl) => {
            document.getElementById(el).innerHTML = list.map((x,i) => `
                <div class="adm-list-item">
                    <span>${lbl(x)}</span>
                    <button style="color:red;background:none;border:none;cursor:pointer;" onclick="state.${el.split('-')[1]}.active.splice(${i},1);adm.renAll()">Del</button>
                </div>
            `).join('');
        }
        ren('list-alerts', state.alerts.active, x=>`${x.weatherType} (${x.regions})`);
        ren('list-swo', state.swo.active, x=>`${x.date} (${x.alertLevel})`);
        ren('list-storm', state.storm.active, x=>`${x.title} (${x.validDate})`);
        ren('list-snow', state.snow.active, x=>`${x.region}`);
        ren('list-drought', state.drought.active, x=>`${x.region} (${x.severity})`);
    },

    // ARCHIVE EXPLORER
    loadArch: () => {
        const t = document.getElementById('arc-tree'); t.innerHTML = 'Loading...';
        const items = [];
        
        // Helper
        const add = (arr, type) => arr.forEach(i => {
            // normalize date
            let d = i.date || i.validDate;
            if(!d && i.startTime) d = i.startTime.split('T')[0];
            if(!d && i.endDate) d = i.endDate; // drought usually endDate
            if(d) {
                const [y,m,day] = d.split('-');
                items.push({y, m, d:day, type, data:i});
            }
        });

        add(state.alerts.arch.concat(state.alerts.active), 'Alert');
        add(state.swo.arch.concat(state.swo.active), 'Outlook');
        add(state.storm.arch.concat(state.storm.active), 'StormCast');
        add(state.snow.arch.concat(state.snow.active), 'SnowCast');
        // Drought is mostly current status, but if needed:
        // add(state.drought.active, 'DroughtCast'); 

        const tree = {};
        items.forEach(x => {
            const mn = new Date(x.y, x.m-1).toLocaleString('default',{month:'long'});
            if(!tree[x.y]) tree[x.y] = {};
            if(!tree[x.y][mn]) tree[x.y][mn] = {};
            if(!tree[x.y][mn][x.d]) tree[x.y][mn][x.d] = [];
            tree[x.y][mn][x.d].push(x);
        });

        // Render Tree HTML
        let h = '';
        Object.keys(tree).sort().reverse().forEach(y => {
            h += `<div><button class="folder" onclick="this.nextElementSibling.hidden = !this.nextElementSibling.hidden">üìÇ ${y}</button><div hidden style="padding-left:15px;">`;
            Object.keys(tree[y]).forEach(m => {
                h += `<div><button class="folder" onclick="this.nextElementSibling.hidden = !this.nextElementSibling.hidden">üìÅ ${m}</button><div hidden style="padding-left:15px;">`;
                Object.keys(tree[y][m]).sort().reverse().forEach(d => {
                    const json = encodeURIComponent(JSON.stringify(tree[y][m][d]));
                    h += `<button class="file" onclick="adm.viewArc('${json}')">üìÑ ${d}</button>`;
                });
                h += `</div></div>`;
            });
            h += `</div></div>`;
        });
        t.innerHTML = h;
    },
    viewArc: (json) => {
        const data = JSON.parse(decodeURIComponent(json));
        document.getElementById('arc-view').innerHTML = data.map(i => {
            const img = i.data.mapUrl || i.data.imageUrl;
            return `
            <div class="feed-item-card">
                <div class="feed-head"><strong>${i.type}</strong></div>
                <div class="feed-body">
                    ${img ? `<img src="${img}" style="width:100%;margin-bottom:10px;border-radius:8px;">` : ''}
                    <p>${i.data.title || i.data.summary || i.data.weatherType || ''}</p>
                </div>
            </div>`;
        }).join('');
    }
};

ui.init();
mapWidget.init = siWidget.init; // Bind Map to public init
</script>
</body>
</html>
